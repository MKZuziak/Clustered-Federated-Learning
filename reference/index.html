
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../how-to-guides/">
      
      
        <link rel="next" href="../examples/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.36">
    
    
      
        <title>Reference - Clustered Federated Learning (CFL)</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.06209087.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#basic-federated-componenets" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Clustered Federated Learning (CFL)" class="md-header__button md-logo" aria-label="Clustered Federated Learning (CFL)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Clustered Federated Learning (CFL)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Reference
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Clustered Federated Learning (CFL)" class="md-nav__button md-logo" aria-label="Clustered Federated Learning (CFL)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Clustered Federated Learning (CFL)
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    What is Federated Clustered Learning (FCL)
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick Set-Up Guide
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../how-to-guides/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Writing Your Own Utility Functions
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Reference
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Reference
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#basic-federated-componenets" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Federated Componenets
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model.federated_model" class="md-nav__link">
    <span class="md-ellipsis">
      federated_model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel" class="md-nav__link">
    <span class="md-ellipsis">
      FederatedModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FederatedModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.__init__--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.attach_dataset_id" class="md-nav__link">
    <span class="md-ellipsis">
      attach_dataset_id
    </span>
  </a>
  
    <nav class="md-nav" aria-label="attach_dataset_id">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.attach_dataset_id--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.evaluate_model" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="evaluate_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.evaluate_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.evaluate_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.get_gradients" class="md-nav__link">
    <span class="md-ellipsis">
      get_gradients
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_gradients">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.get_gradients--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.get_gradients--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.get_gradients--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.get_weights" class="md-nav__link">
    <span class="md-ellipsis">
      get_weights
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_weights">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.get_weights--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.get_weights--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.get_weights--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.preserve_initial_model" class="md-nav__link">
    <span class="md-ellipsis">
      preserve_initial_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="preserve_initial_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.preserve_initial_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.preserve_initial_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.store_model_on_disk" class="md-nav__link">
    <span class="md-ellipsis">
      store_model_on_disk
    </span>
  </a>
  
    <nav class="md-nav" aria-label="store_model_on_disk">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.store_model_on_disk--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.store_model_on_disk--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.train" class="md-nav__link">
    <span class="md-ellipsis">
      train
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.train--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.train--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.transform_func" class="md-nav__link">
    <span class="md-ellipsis">
      transform_func
    </span>
  </a>
  
    <nav class="md-nav" aria-label="transform_func">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.transform_func--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.update_weights" class="md-nav__link">
    <span class="md-ellipsis">
      update_weights
    </span>
  </a>
  
    <nav class="md-nav" aria-label="update_weights">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.update_weights--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.update_weights--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.update_weights--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#node.federated_node" class="md-nav__link">
    <span class="md-ellipsis">
      federated_node
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode" class="md-nav__link">
    <span class="md-ellipsis">
      FederatedNode
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FederatedNode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.connect_data_id" class="md-nav__link">
    <span class="md-ellipsis">
      connect_data_id
    </span>
  </a>
  
    <nav class="md-nav" aria-label="connect_data_id">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.connect_data_id--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.get_weights" class="md-nav__link">
    <span class="md-ellipsis">
      get_weights
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.local_training" class="md-nav__link">
    <span class="md-ellipsis">
      local_training
    </span>
  </a>
  
    <nav class="md-nav" aria-label="local_training">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.local_training--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.local_training--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.train_local_model" class="md-nav__link">
    <span class="md-ellipsis">
      train_local_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train_local_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.train_local_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.train_local_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.update_weights" class="md-nav__link">
    <span class="md-ellipsis">
      update_weights
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simulation.simulation" class="md-nav__link">
    <span class="md-ellipsis">
      simulation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation" class="md-nav__link">
    <span class="md-ellipsis">
      Simulation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Simulation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation--attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.__init__--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.attach_node_model" class="md-nav__link">
    <span class="md-ellipsis">
      attach_node_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="attach_node_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.attach_node_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.attach_orchestrator_model" class="md-nav__link">
    <span class="md-ellipsis">
      attach_orchestrator_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="attach_orchestrator_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.attach_orchestrator_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.attach_orchestrator_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.train_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      train_epoch
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train_epoch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.train_epoch--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.train_epoch--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.training_protocol_baseline" class="md-nav__link">
    <span class="md-ellipsis">
      training_protocol_baseline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="training_protocol_baseline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.training_protocol_baseline--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.training_protocol_briggs" class="md-nav__link">
    <span class="md-ellipsis">
      training_protocol_briggs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="training_protocol_briggs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.training_protocol_briggs--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.training_protocol_energy_oneshot" class="md-nav__link">
    <span class="md-ellipsis">
      training_protocol_energy_oneshot
    </span>
  </a>
  
    <nav class="md-nav" aria-label="training_protocol_energy_oneshot">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.training_protocol_energy_oneshot--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.training_protocol_sattler" class="md-nav__link">
    <span class="md-ellipsis">
      training_protocol_sattler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="training_protocol_sattler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.training_protocol_sattler--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-operations" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Operations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.evaluations" class="md-nav__link">
    <span class="md-ellipsis">
      evaluations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.evaluations.automatic_node_evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      automatic_node_evaluation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="automatic_node_evaluation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.evaluations.automatic_node_evaluation--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations.evaluations.automatic_node_evaluation--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.evaluations.evaluate_model" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="evaluate_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.evaluations.evaluate_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations.evaluations.evaluate_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.orchestrations" class="md-nav__link">
    <span class="md-ellipsis">
      orchestrations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_nodes" class="md-nav__link">
    <span class="md-ellipsis">
      sample_nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sample_nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_nodes--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_nodes--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_weighted_nodes" class="md-nav__link">
    <span class="md-ellipsis">
      sample_weighted_nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sample_weighted_nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_weighted_nodes--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_weighted_nodes--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.orchestrations.train_nodes" class="md-nav__link">
    <span class="md-ellipsis">
      train_nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train_nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.train_nodes--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregators.aggregator" class="md-nav__link">
    <span class="md-ellipsis">
      aggregator
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregators.aggregator.Aggregator" class="md-nav__link">
    <span class="md-ellipsis">
      Aggregator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Aggregator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aggregators.aggregator.Aggregator.aggregate_weights" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate_weights
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggregate_weights">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aggregators.aggregator.Aggregator.aggregate_weights--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregators.aggregator.Aggregator.aggregate_weights--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-file-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Basic File Handling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#files.archive" class="md-nav__link">
    <span class="md-ellipsis">
      archive
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#files.archive.create_archive" class="md-nav__link">
    <span class="md-ellipsis">
      create_archive
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_archive">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#files.archive.create_archive--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#files.archive.create_archive--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#files.handlers" class="md-nav__link">
    <span class="md-ellipsis">
      handlers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#files.handlers.save_dict_ascsv" class="md-nav__link">
    <span class="md-ellipsis">
      save_dict_ascsv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="save_dict_ascsv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#files.handlers.save_dict_ascsv--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#files.handlers.save_nested_dict_ascsv" class="md-nav__link">
    <span class="md-ellipsis">
      save_nested_dict_ascsv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="save_nested_dict_ascsv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#files.handlers.save_nested_dict_ascsv--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#files.loggers" class="md-nav__link">
    <span class="md-ellipsis">
      loggers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-aggregators" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Aggregators
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregators.aggregator" class="md-nav__link">
    <span class="md-ellipsis">
      aggregator
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregators.aggregator.Aggregator" class="md-nav__link">
    <span class="md-ellipsis">
      Aggregator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Aggregator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aggregators.aggregator.Aggregator.aggregate_weights" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate_weights
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggregate_weights">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aggregators.aggregator.Aggregator.aggregate_weights--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregators.aggregator.Aggregator.aggregate_weights--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregators.distances" class="md-nav__link">
    <span class="md-ellipsis">
      distances
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregators.fedopt_aggregator" class="md-nav__link">
    <span class="md-ellipsis">
      fedopt_aggregator
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregators.fedopt_aggregator.Fedopt_Optimizer" class="md-nav__link">
    <span class="md-ellipsis">
      Fedopt_Optimizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fedopt_Optimizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aggregators.fedopt_aggregator.Fedopt_Optimizer--attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregators.fedopt_aggregator.Fedopt_Optimizer.optimize_weights" class="md-nav__link">
    <span class="md-ellipsis">
      optimize_weights
    </span>
  </a>
  
    <nav class="md-nav" aria-label="optimize_weights">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aggregators.fedopt_aggregator.Fedopt_Optimizer.optimize_weights--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregators.fedopt_aggregator.Fedopt_Optimizer.optimize_weights--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregators.temperature" class="md-nav__link">
    <span class="md-ellipsis">
      temperature
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-operations_1" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Operations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.evaluations" class="md-nav__link">
    <span class="md-ellipsis">
      evaluations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.evaluations.automatic_node_evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      automatic_node_evaluation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="automatic_node_evaluation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.evaluations.automatic_node_evaluation--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations.evaluations.automatic_node_evaluation--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.evaluations.evaluate_model" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="evaluate_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.evaluations.evaluate_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations.evaluations.evaluate_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.orchestrations" class="md-nav__link">
    <span class="md-ellipsis">
      orchestrations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_nodes" class="md-nav__link">
    <span class="md-ellipsis">
      sample_nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sample_nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_nodes--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_nodes--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_weighted_nodes" class="md-nav__link">
    <span class="md-ellipsis">
      sample_weighted_nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sample_weighted_nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_weighted_nodes--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_weighted_nodes--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.orchestrations.train_nodes" class="md-nav__link">
    <span class="md-ellipsis">
      train_nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train_nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.train_nodes--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Examples
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#basic-federated-componenets" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Federated Componenets
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model.federated_model" class="md-nav__link">
    <span class="md-ellipsis">
      federated_model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel" class="md-nav__link">
    <span class="md-ellipsis">
      FederatedModel
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FederatedModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.__init__--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.attach_dataset_id" class="md-nav__link">
    <span class="md-ellipsis">
      attach_dataset_id
    </span>
  </a>
  
    <nav class="md-nav" aria-label="attach_dataset_id">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.attach_dataset_id--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.evaluate_model" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="evaluate_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.evaluate_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.evaluate_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.get_gradients" class="md-nav__link">
    <span class="md-ellipsis">
      get_gradients
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_gradients">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.get_gradients--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.get_gradients--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.get_gradients--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.get_weights" class="md-nav__link">
    <span class="md-ellipsis">
      get_weights
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_weights">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.get_weights--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.get_weights--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.get_weights--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.preserve_initial_model" class="md-nav__link">
    <span class="md-ellipsis">
      preserve_initial_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="preserve_initial_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.preserve_initial_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.preserve_initial_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.store_model_on_disk" class="md-nav__link">
    <span class="md-ellipsis">
      store_model_on_disk
    </span>
  </a>
  
    <nav class="md-nav" aria-label="store_model_on_disk">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.store_model_on_disk--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.store_model_on_disk--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.train" class="md-nav__link">
    <span class="md-ellipsis">
      train
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.train--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.train--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.transform_func" class="md-nav__link">
    <span class="md-ellipsis">
      transform_func
    </span>
  </a>
  
    <nav class="md-nav" aria-label="transform_func">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.transform_func--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.update_weights" class="md-nav__link">
    <span class="md-ellipsis">
      update_weights
    </span>
  </a>
  
    <nav class="md-nav" aria-label="update_weights">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.update_weights--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.update_weights--raises" class="md-nav__link">
    <span class="md-ellipsis">
      Raises
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model.federated_model.FederatedModel.update_weights--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#node.federated_node" class="md-nav__link">
    <span class="md-ellipsis">
      federated_node
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode" class="md-nav__link">
    <span class="md-ellipsis">
      FederatedNode
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FederatedNode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.connect_data_id" class="md-nav__link">
    <span class="md-ellipsis">
      connect_data_id
    </span>
  </a>
  
    <nav class="md-nav" aria-label="connect_data_id">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.connect_data_id--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.get_weights" class="md-nav__link">
    <span class="md-ellipsis">
      get_weights
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.local_training" class="md-nav__link">
    <span class="md-ellipsis">
      local_training
    </span>
  </a>
  
    <nav class="md-nav" aria-label="local_training">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.local_training--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.local_training--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.train_local_model" class="md-nav__link">
    <span class="md-ellipsis">
      train_local_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train_local_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.train_local_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.train_local_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node.federated_node.FederatedNode.update_weights" class="md-nav__link">
    <span class="md-ellipsis">
      update_weights
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simulation.simulation" class="md-nav__link">
    <span class="md-ellipsis">
      simulation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation" class="md-nav__link">
    <span class="md-ellipsis">
      Simulation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Simulation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation--attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.__init__--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.attach_node_model" class="md-nav__link">
    <span class="md-ellipsis">
      attach_node_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="attach_node_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.attach_node_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.attach_orchestrator_model" class="md-nav__link">
    <span class="md-ellipsis">
      attach_orchestrator_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="attach_orchestrator_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.attach_orchestrator_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.attach_orchestrator_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.train_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      train_epoch
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train_epoch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.train_epoch--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.train_epoch--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.training_protocol_baseline" class="md-nav__link">
    <span class="md-ellipsis">
      training_protocol_baseline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="training_protocol_baseline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.training_protocol_baseline--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.training_protocol_briggs" class="md-nav__link">
    <span class="md-ellipsis">
      training_protocol_briggs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="training_protocol_briggs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.training_protocol_briggs--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.training_protocol_energy_oneshot" class="md-nav__link">
    <span class="md-ellipsis">
      training_protocol_energy_oneshot
    </span>
  </a>
  
    <nav class="md-nav" aria-label="training_protocol_energy_oneshot">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.training_protocol_energy_oneshot--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.training_protocol_sattler" class="md-nav__link">
    <span class="md-ellipsis">
      training_protocol_sattler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="training_protocol_sattler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simulation.simulation.Simulation.training_protocol_sattler--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-operations" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Operations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.evaluations" class="md-nav__link">
    <span class="md-ellipsis">
      evaluations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.evaluations.automatic_node_evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      automatic_node_evaluation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="automatic_node_evaluation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.evaluations.automatic_node_evaluation--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations.evaluations.automatic_node_evaluation--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.evaluations.evaluate_model" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="evaluate_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.evaluations.evaluate_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations.evaluations.evaluate_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.orchestrations" class="md-nav__link">
    <span class="md-ellipsis">
      orchestrations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_nodes" class="md-nav__link">
    <span class="md-ellipsis">
      sample_nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sample_nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_nodes--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_nodes--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_weighted_nodes" class="md-nav__link">
    <span class="md-ellipsis">
      sample_weighted_nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sample_weighted_nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_weighted_nodes--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_weighted_nodes--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.orchestrations.train_nodes" class="md-nav__link">
    <span class="md-ellipsis">
      train_nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train_nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.train_nodes--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregators.aggregator" class="md-nav__link">
    <span class="md-ellipsis">
      aggregator
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregators.aggregator.Aggregator" class="md-nav__link">
    <span class="md-ellipsis">
      Aggregator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Aggregator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aggregators.aggregator.Aggregator.aggregate_weights" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate_weights
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggregate_weights">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aggregators.aggregator.Aggregator.aggregate_weights--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregators.aggregator.Aggregator.aggregate_weights--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-file-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Basic File Handling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#files.archive" class="md-nav__link">
    <span class="md-ellipsis">
      archive
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#files.archive.create_archive" class="md-nav__link">
    <span class="md-ellipsis">
      create_archive
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_archive">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#files.archive.create_archive--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#files.archive.create_archive--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#files.handlers" class="md-nav__link">
    <span class="md-ellipsis">
      handlers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#files.handlers.save_dict_ascsv" class="md-nav__link">
    <span class="md-ellipsis">
      save_dict_ascsv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="save_dict_ascsv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#files.handlers.save_dict_ascsv--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#files.handlers.save_nested_dict_ascsv" class="md-nav__link">
    <span class="md-ellipsis">
      save_nested_dict_ascsv
    </span>
  </a>
  
    <nav class="md-nav" aria-label="save_nested_dict_ascsv">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#files.handlers.save_nested_dict_ascsv--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#files.loggers" class="md-nav__link">
    <span class="md-ellipsis">
      loggers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-aggregators" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Aggregators
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregators.aggregator" class="md-nav__link">
    <span class="md-ellipsis">
      aggregator
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregators.aggregator.Aggregator" class="md-nav__link">
    <span class="md-ellipsis">
      Aggregator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Aggregator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aggregators.aggregator.Aggregator.aggregate_weights" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate_weights
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggregate_weights">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aggregators.aggregator.Aggregator.aggregate_weights--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregators.aggregator.Aggregator.aggregate_weights--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregators.distances" class="md-nav__link">
    <span class="md-ellipsis">
      distances
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregators.fedopt_aggregator" class="md-nav__link">
    <span class="md-ellipsis">
      fedopt_aggregator
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregators.fedopt_aggregator.Fedopt_Optimizer" class="md-nav__link">
    <span class="md-ellipsis">
      Fedopt_Optimizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fedopt_Optimizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aggregators.fedopt_aggregator.Fedopt_Optimizer--attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Attributes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregators.fedopt_aggregator.Fedopt_Optimizer.optimize_weights" class="md-nav__link">
    <span class="md-ellipsis">
      optimize_weights
    </span>
  </a>
  
    <nav class="md-nav" aria-label="optimize_weights">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aggregators.fedopt_aggregator.Fedopt_Optimizer.optimize_weights--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregators.fedopt_aggregator.Fedopt_Optimizer.optimize_weights--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregators.temperature" class="md-nav__link">
    <span class="md-ellipsis">
      temperature
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-operations_1" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Operations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.evaluations" class="md-nav__link">
    <span class="md-ellipsis">
      evaluations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.evaluations.automatic_node_evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      automatic_node_evaluation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="automatic_node_evaluation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.evaluations.automatic_node_evaluation--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations.evaluations.automatic_node_evaluation--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.evaluations.evaluate_model" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="evaluate_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.evaluations.evaluate_model--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations.evaluations.evaluate_model--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.orchestrations" class="md-nav__link">
    <span class="md-ellipsis">
      orchestrations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_nodes" class="md-nav__link">
    <span class="md-ellipsis">
      sample_nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sample_nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_nodes--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_nodes--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_weighted_nodes" class="md-nav__link">
    <span class="md-ellipsis">
      sample_weighted_nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sample_weighted_nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_weighted_nodes--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.sample_weighted_nodes--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operations.orchestrations.train_nodes" class="md-nav__link">
    <span class="md-ellipsis">
      train_nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="train_nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operations.orchestrations.train_nodes--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Reference</h1>

<h2 id="basic-federated-componenets">Basic Federated Componenets</h2>


<div class="doc doc-object doc-module">



<a id="model.federated_model"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="model.federated_model.FederatedModel" class="doc doc-heading">
            <code>FederatedModel</code>


</h2>


    <div class="doc doc-contents ">


        <p>This class is used to encapsulate the (PyTorch) federated model that
we will train. It accepts only the PyTorch models and 
provides a utility functions to initialize the model, 
retrieve the weights or perform an indicated number of traning
epochs.</p>

              <details class="quote">
                <summary>Source code in <code>EFL\model\federated_model.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">FederatedModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class is used to encapsulate the (PyTorch) federated model that</span>
<span class="sd">    we will train. It accepts only the PyTorch models and </span>
<span class="sd">    provides a utility functions to initialize the model, </span>
<span class="sd">    retrieve the weights or perform an indicated number of traning</span>
<span class="sd">    epochs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">net</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
        <span class="n">optimizer_template</span><span class="p">:</span> <span class="n">partial</span><span class="p">,</span>
        <span class="n">loader_batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">force_cpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the Federated Model. This model will be attached to a </span>
<span class="sd">        specific client and will wait for further instructionss</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        net: nn.Module </span>
<span class="sd">            The Neural Network architecture that we want to use.</span>
<span class="sd">        optimizer_template: functools.partial</span>
<span class="sd">            The partial function of the optimizer that will be used as a template</span>
<span class="sd">        node_name: int | str</span>
<span class="sd">            The name of the node</span>
<span class="sd">        loader_batch_size: int</span>
<span class="sd">            Batch size of the trainloader and testloader.</span>
<span class="sd">        force_gpu: bool = False</span>
<span class="sd">            Option to force the calculations on cpu even if the gpu is available.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Primary computation device: GPU or CPU</span>
        <span class="k">if</span> <span class="n">force_cpu</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

        <span class="c1"># Second computaiton device to offload parameters: CPU</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initial_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="kc">None</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">loader_batch_size</span>
        <span class="c1"># List containing all the parameters to update</span>
        <span class="n">params_to_update</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">params_to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer_template</span><span class="p">(</span><span class="n">params_to_update</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">attach_dataset_id</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">local_dataset</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">datasets</span><span class="o">.</span><span class="n">arrow_dataset</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">datasets</span><span class="o">.</span><span class="n">arrow_dataset</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">datasets</span><span class="o">.</span><span class="n">arrow_dataset</span><span class="o">.</span><span class="n">Dataset</span><span class="p">],</span>
        <span class="n">node_name</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">only_test</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">hugging_face_map</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attaches huggingface dataset to the model by firstly converting it into a pytorch-appropiate standard.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        local_dataset: list[datasets.arrow_dataset.Dataset] </span>
<span class="sd">            A local dataset that should be loaded into DataLoader</span>
<span class="sd">        node_name: int | str</span>
<span class="sd">            The name of the node attributed to particular dataset</span>
<span class="sd">        only_test: bool [default to False]: </span>
<span class="sd">            If true, only a test set will be returned</span>
<span class="sd">        batch_size: int [default to 32]:</span>
<span class="sd">            Batch size used in test and train loader</span>
<span class="sd">        higging_face_map: bool [default to True]:</span>
<span class="sd">            If set to True, will use hugging face map function,</span>
<span class="sd">            that takes more time to process but results in a more</span>
<span class="sd">            stable and reversable transformation of the results.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">node_name</span>
        <span class="k">if</span> <span class="n">only_test</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hugging_face_map</span><span class="p">:</span>
                <span class="n">convert_tensor</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>
                <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sample</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">convert_tensor</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">])})</span>
                <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_format</span><span class="p">(</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="n">output_all_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">local_dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sample</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">convert_tensor</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">])})</span>
                <span class="n">local_dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_format</span><span class="p">(</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="n">output_all_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">with_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_func</span><span class="p">)</span>
                <span class="n">local_dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">with_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_func</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trainloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
                <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">testloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
                <span class="n">local_dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hugging_face_map</span><span class="p">:</span>
                <span class="n">convert_tensor</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>
                <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sample</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">convert_tensor</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">])})</span>
                <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_format</span><span class="p">(</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="n">output_all_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">with_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_func</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">testloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
                <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>


    <span class="c1"># def print_model_footprint(self) -&gt; None:</span>
    <span class="c1">#     &quot;&quot;&quot;Prints all the information about the model..</span>
    <span class="c1">#     Args:</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     unique_hash = hash(next(iter(self.trainloader))[&#39;image&#39;] + self.node_name)</span>

    <span class="c1">#     string = f&quot;&quot;&quot;</span>
    <span class="c1">#     model id: {self.node_name}</span>
    <span class="c1">#     device: {self.device},</span>
    <span class="c1">#     optimizer: {self.optimizer},</span>
    <span class="c1">#     unique hash: {unique_hash}</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     return (self.node_name, self.device, self.optimizer, unique_hash)</span>

    <span class="c1">#     # num_examples = {</span>
    <span class="c1">#     #     &quot;trainset&quot;: len(self.training_set),</span>
    <span class="c1">#     #     &quot;testset&quot;: len(self.test_set),</span>
    <span class="c1">#     # }</span>
    <span class="c1">#     # targets = []</span>
    <span class="c1">#     # for _, data in enumerate(trainloader, 0):</span>
    <span class="c1">#     #     targets.append(data[1])</span>
    <span class="c1">#     # targets = [item.item() for sublist in targets for item in sublist]</span>
    <span class="c1">#     # model_logger.info(f&quot;{self.node_name}, {Counter(targets)}&quot;)</span>
    <span class="c1">#     # model_logger.info(f&quot;{self.node_name}: Training set size: {num_examples[&#39;trainset&#39;]}&quot;)</span>
    <span class="c1">#     # model_logger.info(f&quot;{self.node_name}: Test set size: {num_examples[&#39;testset&#39;]}&quot;)</span>


    <span class="c1"># def get_weights_list(self) -&gt; list[float]:</span>
    <span class="c1">#     &quot;&quot;&quot;Get the parameters of the network.</span>

    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>

    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     List[float]: parameters of the network</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     return [val.cpu().numpy() for _, val in self.net.state_dict().items()]</span>


    <span class="k">def</span> <span class="nf">get_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the weights of the network.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Raises</span>
<span class="sd">        -------------</span>
<span class="sd">            Exception: if the model is not initialized it raises an exception.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------------</span>
<span class="sd">            _type_: weights of the network</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpu</span><span class="p">)</span> <span class="c1"># Dupming weights on cpu.</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>


    <span class="k">def</span> <span class="nf">get_gradients</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the gradients of the network (differences between received and trained model)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Raises</span>
<span class="sd">        -------------</span>
<span class="sd">            Exception: if the original model was not preserved.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------------</span>
<span class="sd">            Oredered_Dict: Gradients of the network.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_model</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Computing gradients require saving initial model first!&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpu</span><span class="p">)</span> <span class="c1"># Dupming weights on cpu.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpu</span><span class="p">)</span>
        <span class="n">weights_t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
        <span class="n">weights_t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">weights_t1</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">weights_t1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span>  <span class="n">weights_t1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-</span> <span class="n">weights_t2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span> <span class="c1"># Try: to provide original weights, no copies</span>


    <span class="k">def</span> <span class="nf">update_weights</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">avg_tensors</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the weights of the network stored on client with passed tensors.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        avg_tensors: Ordered_Dict</span>
<span class="sd">            An Ordered Dictionary containing a averaged tensors</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Exception: _description_</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">avg_tensors</span><span class="p">),</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">store_model_on_disk</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves local model in a .pt format.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Iteration: int</span>
<span class="sd">            Current iteration</span>
<span class="sd">        Path: str</span>
<span class="sd">            Path to the saved repository</span>

<span class="sd">        Returns: </span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Raises</span>
<span class="sd">        -------</span>
<span class="sd">            Exception if the model is not initialized it raises an exception</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;node_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_name</span><span class="si">}</span><span class="s2">_iteration_</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">.pt&quot;</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
            <span class="n">save_path</span><span class="p">,</span>
        <span class="p">)</span>


    <span class="k">def</span> <span class="nf">preserve_initial_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Preserve the initial model provided at the</span>
<span class="sd">        end of the turn (necessary for computing gradients,</span>
<span class="sd">        when using aggregating methods such as FedOpt).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            Tuple[float, float]: Loss and accuracy on the training set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Train the network and computes loss and accuracy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        iterations: int </span>
<span class="sd">            Current iteration</span>
<span class="sd">        epoch: int</span>
<span class="sd">            Current (local) epoch</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">criterion</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
        <span class="n">train_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Try: to place a net on the device during the training stage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">dic</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainloader</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
            <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span> <span class="c1"># Zero grading the network                        </span>
            <span class="c1"># forward pass, backward pass and optimization</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">targets</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="n">predicted</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="c1"># Emptying the cuda_cache</span>
            <span class="c1"># if torch.cuda.is_available():</span>
            <span class="c1">#     torch.cuda.empty_cache()</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="n">train_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainloader</span><span class="p">)</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span>
        <span class="n">model_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2"> | EPOCH </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> | NODE </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_name</span><span class="si">}</span><span class="s2">] Training on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> results: loss: </span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s2">, accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">loss</span><span class="p">,</span> 
                <span class="n">accuracy</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">evaluate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate the network on the local test set.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            Tuple[float, float]: loss and accuracy on the test set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Try: to place net on device directly during the evaluation stage.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">evaluation_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">criterion</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
        <span class="n">test_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">dic</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testloader</span><span class="p">):</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
                <span class="n">targets</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
                <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

                <span class="n">total</span> <span class="o">+=</span> <span class="n">targets</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">test_loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_loss</span><span class="p">)</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">correct</span> <span class="o">+=</span> <span class="n">pred</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">targets</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">y_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
                <span class="n">y_true</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>

        <span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;test_loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
        <span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span>

        <span class="n">y_true</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">y_true</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">y_pred</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

        <span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;f1score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span><span class="p">)</span>
        <span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span><span class="p">)</span>
        <span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span><span class="p">)</span>

        <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)])</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">cm</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">accuracy_per_class</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
        <span class="n">accuracy_per_class_expanded</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s1">&#39;accuracy_per_</span><span class="si">{</span><span class="n">class_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">class_id</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">accuracy_per_class</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">evaluation_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">accuracy_per_class_expanded</span><span class="p">)</span>

        <span class="c1"># true_positives = np.diag(cm)</span>
        <span class="c1"># num_classes = len(list(set(y_true)))</span>

        <span class="c1"># false_positives = []</span>
        <span class="c1"># for i in range(num_classes):</span>
        <span class="c1">#     false_positives.append(sum(cm[:,i]) - cm[i,i])</span>

        <span class="c1"># false_negatives = []</span>
        <span class="c1"># for i in range(num_classes):</span>
        <span class="c1">#     false_negatives.append(sum(cm[i,:]) - cm[i,i])</span>

        <span class="c1"># true_negatives = []</span>
        <span class="c1"># for i in range(num_classes):</span>
        <span class="c1">#     temp = np.delete(cm, i, 0)   # delete ith row</span>
        <span class="c1">#     temp = np.delete(temp, i, 1)  # delete ith column</span>
        <span class="c1">#     true_negatives.append(sum(sum(temp)))</span>

        <span class="c1"># denominator = [sum(x) for x in zip(false_positives, true_negatives)]</span>
        <span class="c1"># false_positive_rate = [num/den for num, den in zip(false_positives, denominator)]</span>

        <span class="c1"># denominator = [sum(x) for x in zip(true_positives, false_negatives)]</span>
        <span class="c1"># true_positive_rate = [num/den for num, den in zip(true_positives, denominator)]</span>

        <span class="c1"># # # Emptying the cuda_cache</span>
        <span class="c1"># # if torch.cuda.is_available():</span>
        <span class="c1"># #     torch.cuda.empty_cache()</span>

        <span class="k">return</span> <span class="n">evaluation_results</span>


    <span class="c1"># def quick_evaluate(self) -&gt; tuple[float, float]:</span>
    <span class="c1">#     &quot;&quot;&quot;Quicker version of the evaluate_model(function) </span>
    <span class="c1">#     Validate the network on the local test set returning only the loss and accuracy.</span>

    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>

    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#         Tuple[float, float]: loss and accuracy on the test set.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     # Try: to place net on device directly during the evaluation stage.</span>
    <span class="c1">#     self.net.to(self.device)</span>
    <span class="c1">#     criterion = nn.CrossEntropyLoss()</span>
    <span class="c1">#     test_loss = 0</span>
    <span class="c1">#     correct = 0</span>
    <span class="c1">#     total = 0</span>

    <span class="c1">#     with torch.no_grad():</span>
    <span class="c1">#         for _, dic in enumerate(self.testloader):</span>
    <span class="c1">#             inputs = dic[&#39;image&#39;]</span>
    <span class="c1">#             targets = dic[&#39;label&#39;]</span>
    <span class="c1">#             inputs, targets = inputs.to(self.device), targets.to(self.device)</span>
    <span class="c1">#             outputs = self.net(inputs)</span>
    <span class="c1">#             loss = criterion(outputs, targets)</span>

    <span class="c1">#             test_loss += loss.item()</span>
    <span class="c1">#             _, predicted = outputs.max(1)</span>
    <span class="c1">#             total += targets.size(0)</span>
    <span class="c1">#             correct += predicted.eq(targets).sum().item()</span>

    <span class="c1">#     test_loss = test_loss / len(self.testloader)</span>
    <span class="c1">#     accuracy = correct / total</span>

    <span class="c1">#     # # Emptying the cuda_cache</span>
    <span class="c1">#     # if torch.cuda.is_available():</span>
    <span class="c1">#     #     torch.cuda.empty_cache()</span>

    <span class="c1">#     return (</span>
    <span class="c1">#         test_loss,</span>
    <span class="c1">#         accuracy</span>
    <span class="c1">#         )</span>


    <span class="k">def</span> <span class="nf">transform_func</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">arrow_dataset</span><span class="o">.</span><span class="n">Dataset</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Convers datasets.arrow_dataset.Dataset into a PyTorch Tensor</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        local_dataset: datasets.arrow_dataset.Dataset</span>
<span class="sd">            A local dataset that should be loaded into DataLoader</span>
<span class="sd">        only_test: bool [default to False]: </span>
<span class="sd">            If true, only a test set will be returned</span>

<span class="sd">        Returns</span>
<span class="sd">        -------------</span>
<span class="sd">        None&quot;&quot;&quot;</span>
        <span class="n">convert_tensor</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">convert_tensor</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="model.federated_model.FederatedModel.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">optimizer_template</span><span class="p">,</span> <span class="n">loader_batch_size</span><span class="p">,</span> <span class="n">force_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize the Federated Model. This model will be attached to a 
specific client and will wait for further instructionss</p>
<h5 id="model.federated_model.FederatedModel.__init__--parameters">Parameters</h5>
<p>net: nn.Module 
    The Neural Network architecture that we want to use.
optimizer_template: functools.partial
    The partial function of the optimizer that will be used as a template
node_name: int | str
    The name of the node
loader_batch_size: int
    Batch size of the trainloader and testloader.
force_gpu: bool = False
    Option to force the calculations on cpu even if the gpu is available.</p>
<h5 id="model.federated_model.FederatedModel.__init__--returns">Returns</h5>
<p>None</p>

            <details class="quote">
              <summary>Source code in <code>EFL\model\federated_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">net</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
    <span class="n">optimizer_template</span><span class="p">:</span> <span class="n">partial</span><span class="p">,</span>
    <span class="n">loader_batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">force_cpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the Federated Model. This model will be attached to a </span>
<span class="sd">    specific client and will wait for further instructionss</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    net: nn.Module </span>
<span class="sd">        The Neural Network architecture that we want to use.</span>
<span class="sd">    optimizer_template: functools.partial</span>
<span class="sd">        The partial function of the optimizer that will be used as a template</span>
<span class="sd">    node_name: int | str</span>
<span class="sd">        The name of the node</span>
<span class="sd">    loader_batch_size: int</span>
<span class="sd">        Batch size of the trainloader and testloader.</span>
<span class="sd">    force_gpu: bool = False</span>
<span class="sd">        Option to force the calculations on cpu even if the gpu is available.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Primary computation device: GPU or CPU</span>
    <span class="k">if</span> <span class="n">force_cpu</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

    <span class="c1"># Second computaiton device to offload parameters: CPU</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">initial_model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="kc">None</span>  
    <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">loader_batch_size</span>
    <span class="c1"># List containing all the parameters to update</span>
    <span class="n">params_to_update</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">params_to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer_template</span><span class="p">(</span><span class="n">params_to_update</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="model.federated_model.FederatedModel.attach_dataset_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">attach_dataset_id</span><span class="p">(</span><span class="n">local_dataset</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">only_test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hugging_face_map</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Attaches huggingface dataset to the model by firstly converting it into a pytorch-appropiate standard.</p>
<h5 id="model.federated_model.FederatedModel.attach_dataset_id--parameters">Parameters</h5>
<p>local_dataset: list[datasets.arrow_dataset.Dataset] 
    A local dataset that should be loaded into DataLoader
node_name: int | str
    The name of the node attributed to particular dataset
only_test: bool [default to False]: 
    If true, only a test set will be returned
batch_size: int [default to 32]:
    Batch size used in test and train loader
higging_face_map: bool [default to True]:
    If set to True, will use hugging face map function,
    that takes more time to process but results in a more
    stable and reversable transformation of the results.
Returns</p>
<hr />
<p>None</p>

            <details class="quote">
              <summary>Source code in <code>EFL\model\federated_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">attach_dataset_id</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">local_dataset</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">datasets</span><span class="o">.</span><span class="n">arrow_dataset</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">datasets</span><span class="o">.</span><span class="n">arrow_dataset</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">datasets</span><span class="o">.</span><span class="n">arrow_dataset</span><span class="o">.</span><span class="n">Dataset</span><span class="p">],</span>
    <span class="n">node_name</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">only_test</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">hugging_face_map</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Attaches huggingface dataset to the model by firstly converting it into a pytorch-appropiate standard.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    local_dataset: list[datasets.arrow_dataset.Dataset] </span>
<span class="sd">        A local dataset that should be loaded into DataLoader</span>
<span class="sd">    node_name: int | str</span>
<span class="sd">        The name of the node attributed to particular dataset</span>
<span class="sd">    only_test: bool [default to False]: </span>
<span class="sd">        If true, only a test set will be returned</span>
<span class="sd">    batch_size: int [default to 32]:</span>
<span class="sd">        Batch size used in test and train loader</span>
<span class="sd">    higging_face_map: bool [default to True]:</span>
<span class="sd">        If set to True, will use hugging face map function,</span>
<span class="sd">        that takes more time to process but results in a more</span>
<span class="sd">        stable and reversable transformation of the results.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">node_name</span>
    <span class="k">if</span> <span class="n">only_test</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">hugging_face_map</span><span class="p">:</span>
            <span class="n">convert_tensor</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>
            <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sample</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">convert_tensor</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">])})</span>
            <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_format</span><span class="p">(</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="n">output_all_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">local_dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sample</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">convert_tensor</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">])})</span>
            <span class="n">local_dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_format</span><span class="p">(</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="n">output_all_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">with_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_func</span><span class="p">)</span>
            <span class="n">local_dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">with_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_func</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">local_dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">hugging_face_map</span><span class="p">:</span>
            <span class="n">convert_tensor</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>
            <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sample</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">convert_tensor</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">])})</span>
            <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_format</span><span class="p">(</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="n">output_all_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">with_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_func</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">local_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="model.federated_model.FederatedModel.evaluate_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate_model</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Validate the network on the local test set.</p>
<h5 id="model.federated_model.FederatedModel.evaluate_model--parameters">Parameters</h5>
<h5 id="model.federated_model.FederatedModel.evaluate_model--returns">Returns</h5>
<pre><code>Tuple[float, float]: loss and accuracy on the test set.
</code></pre>

            <details class="quote">
              <summary>Source code in <code>EFL\model\federated_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">evaluate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate the network on the local test set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        Tuple[float, float]: loss and accuracy on the test set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Try: to place net on device directly during the evaluation stage.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">evaluation_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
    <span class="n">test_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_true</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">dic</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testloader</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
            <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

            <span class="n">total</span> <span class="o">+=</span> <span class="n">targets</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">test_loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_loss</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="n">pred</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">targets</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">y_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
            <span class="n">y_true</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>

    <span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;test_loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
    <span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span>

    <span class="n">y_true</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">y_true</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">y_pred</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

    <span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;f1score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span><span class="p">)</span>
    <span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span><span class="p">)</span>
    <span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span><span class="p">)</span>

    <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)])</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">cm</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">accuracy_per_class</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
    <span class="n">accuracy_per_class_expanded</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sa">f</span><span class="s1">&#39;accuracy_per_</span><span class="si">{</span><span class="n">class_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">class_id</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">accuracy_per_class</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">evaluation_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">accuracy_per_class_expanded</span><span class="p">)</span>

    <span class="c1"># true_positives = np.diag(cm)</span>
    <span class="c1"># num_classes = len(list(set(y_true)))</span>

    <span class="c1"># false_positives = []</span>
    <span class="c1"># for i in range(num_classes):</span>
    <span class="c1">#     false_positives.append(sum(cm[:,i]) - cm[i,i])</span>

    <span class="c1"># false_negatives = []</span>
    <span class="c1"># for i in range(num_classes):</span>
    <span class="c1">#     false_negatives.append(sum(cm[i,:]) - cm[i,i])</span>

    <span class="c1"># true_negatives = []</span>
    <span class="c1"># for i in range(num_classes):</span>
    <span class="c1">#     temp = np.delete(cm, i, 0)   # delete ith row</span>
    <span class="c1">#     temp = np.delete(temp, i, 1)  # delete ith column</span>
    <span class="c1">#     true_negatives.append(sum(sum(temp)))</span>

    <span class="c1"># denominator = [sum(x) for x in zip(false_positives, true_negatives)]</span>
    <span class="c1"># false_positive_rate = [num/den for num, den in zip(false_positives, denominator)]</span>

    <span class="c1"># denominator = [sum(x) for x in zip(true_positives, false_negatives)]</span>
    <span class="c1"># true_positive_rate = [num/den for num, den in zip(true_positives, denominator)]</span>

    <span class="c1"># # # Emptying the cuda_cache</span>
    <span class="c1"># # if torch.cuda.is_available():</span>
    <span class="c1"># #     torch.cuda.empty_cache()</span>

    <span class="k">return</span> <span class="n">evaluation_results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="model.federated_model.FederatedModel.get_gradients" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_gradients</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get the gradients of the network (differences between received and trained model)</p>
<h5 id="model.federated_model.FederatedModel.get_gradients--parameters">Parameters</h5>
<h5 id="model.federated_model.FederatedModel.get_gradients--raises">Raises</h5>
<pre><code>Exception: if the original model was not preserved.
</code></pre>
<h5 id="model.federated_model.FederatedModel.get_gradients--returns">Returns</h5>
<pre><code>Oredered_Dict: Gradients of the network.
</code></pre>

            <details class="quote">
              <summary>Source code in <code>EFL\model\federated_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_gradients</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the gradients of the network (differences between received and trained model)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    Raises</span>
<span class="sd">    -------------</span>
<span class="sd">        Exception: if the original model was not preserved.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------------</span>
<span class="sd">        Oredered_Dict: Gradients of the network.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_model</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Computing gradients require saving initial model first!&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpu</span><span class="p">)</span> <span class="c1"># Dupming weights on cpu.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">initial_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpu</span><span class="p">)</span>
    <span class="n">weights_t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
    <span class="n">weights_t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">weights_t1</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">weights_t1</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span>  <span class="n">weights_t1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-</span> <span class="n">weights_t2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span> <span class="c1"># Try: to provide original weights, no copies</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="model.federated_model.FederatedModel.get_weights" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_weights</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get the weights of the network.</p>
<h5 id="model.federated_model.FederatedModel.get_weights--parameters">Parameters</h5>
<h5 id="model.federated_model.FederatedModel.get_weights--raises">Raises</h5>
<pre><code>Exception: if the model is not initialized it raises an exception.
</code></pre>
<h5 id="model.federated_model.FederatedModel.get_weights--returns">Returns</h5>
<pre><code>_type_: weights of the network
</code></pre>

            <details class="quote">
              <summary>Source code in <code>EFL\model\federated_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the weights of the network.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    Raises</span>
<span class="sd">    -------------</span>
<span class="sd">        Exception: if the model is not initialized it raises an exception.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------------</span>
<span class="sd">        _type_: weights of the network</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpu</span><span class="p">)</span> <span class="c1"># Dupming weights on cpu.</span>
    <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="model.federated_model.FederatedModel.preserve_initial_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">preserve_initial_model</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Preserve the initial model provided at the
end of the turn (necessary for computing gradients,
when using aggregating methods such as FedOpt).</p>
<h5 id="model.federated_model.FederatedModel.preserve_initial_model--parameters">Parameters</h5>
<h5 id="model.federated_model.FederatedModel.preserve_initial_model--returns">Returns</h5>
<pre><code>Tuple[float, float]: Loss and accuracy on the training set.
</code></pre>

            <details class="quote">
              <summary>Source code in <code>EFL\model\federated_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">preserve_initial_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Preserve the initial model provided at the</span>
<span class="sd">    end of the turn (necessary for computing gradients,</span>
<span class="sd">    when using aggregating methods such as FedOpt).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        Tuple[float, float]: Loss and accuracy on the training set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">initial_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="model.federated_model.FederatedModel.store_model_on_disk" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">store_model_on_disk</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Saves local model in a .pt format.
Parameters</p>
<hr />
<p>Iteration: int
    Current iteration
Path: str
    Path to the saved repository</p>
<h5 id="model.federated_model.FederatedModel.store_model_on_disk--returns">Returns:</h5>
<p>None</p>
<h5 id="model.federated_model.FederatedModel.store_model_on_disk--raises">Raises</h5>
<pre><code>Exception if the model is not initialized it raises an exception
</code></pre>

            <details class="quote">
              <summary>Source code in <code>EFL\model\federated_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">store_model_on_disk</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Saves local model in a .pt format.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Iteration: int</span>
<span class="sd">        Current iteration</span>
<span class="sd">    Path: str</span>
<span class="sd">        Path to the saved repository</span>

<span class="sd">    Returns: </span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Raises</span>
<span class="sd">    -------</span>
<span class="sd">        Exception if the model is not initialized it raises an exception</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;node_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_name</span><span class="si">}</span><span class="s2">_iteration_</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">.pt&quot;</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
        <span class="n">save_path</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="model.federated_model.FederatedModel.train" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Train the network and computes loss and accuracy.</p>
<h5 id="model.federated_model.FederatedModel.train--parameters">Parameters</h5>
<p>iterations: int 
    Current iteration
epoch: int
    Current (local) epoch</p>
<h5 id="model.federated_model.FederatedModel.train--returns">Returns</h5>
<p>None</p>

            <details class="quote">
              <summary>Source code in <code>EFL\model\federated_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Train the network and computes loss and accuracy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    iterations: int </span>
<span class="sd">        Current iteration</span>
<span class="sd">    epoch: int</span>
<span class="sd">        Current (local) epoch</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
    <span class="n">train_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Try: to place a net on the device during the training stage</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">dic</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainloader</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
        <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span> <span class="c1"># Zero grading the network                        </span>
        <span class="c1"># forward pass, backward pass and optimization</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">targets</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">correct</span> <span class="o">+=</span> <span class="n">predicted</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="c1"># Emptying the cuda_cache</span>
        <span class="c1"># if torch.cuda.is_available():</span>
        <span class="c1">#     torch.cuda.empty_cache()</span>

    <span class="n">loss</span> <span class="o">=</span> <span class="n">train_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainloader</span><span class="p">)</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span>
    <span class="n">model_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2"> | EPOCH </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> | NODE </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_name</span><span class="si">}</span><span class="s2">] Training on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> results: loss: </span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s2">, accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">loss</span><span class="p">,</span> 
            <span class="n">accuracy</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="model.federated_model.FederatedModel.transform_func" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">transform_func</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Convers datasets.arrow_dataset.Dataset into a PyTorch Tensor
Parameters</p>
<hr />
<p>local_dataset: datasets.arrow_dataset.Dataset
    A local dataset that should be loaded into DataLoader
only_test: bool [default to False]: 
    If true, only a test set will be returned</p>
<h5 id="model.federated_model.FederatedModel.transform_func--returns">Returns</h5>
<p>None</p>

            <details class="quote">
              <summary>Source code in <code>EFL\model\federated_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">transform_func</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">datasets</span><span class="o">.</span><span class="n">arrow_dataset</span><span class="o">.</span><span class="n">Dataset</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Convers datasets.arrow_dataset.Dataset into a PyTorch Tensor</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    local_dataset: datasets.arrow_dataset.Dataset</span>
<span class="sd">        A local dataset that should be loaded into DataLoader</span>
<span class="sd">    only_test: bool [default to False]: </span>
<span class="sd">        If true, only a test set will be returned</span>

<span class="sd">    Returns</span>
<span class="sd">    -------------</span>
<span class="sd">    None&quot;&quot;&quot;</span>
    <span class="n">convert_tensor</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">convert_tensor</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="model.federated_model.FederatedModel.update_weights" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_weights</span><span class="p">(</span><span class="n">avg_tensors</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Updates the weights of the network stored on client with passed tensors.</p>
<h5 id="model.federated_model.FederatedModel.update_weights--parameters">Parameters</h5>
<p>avg_tensors: Ordered_Dict
    An Ordered Dictionary containing a averaged tensors</p>
<h5 id="model.federated_model.FederatedModel.update_weights--raises">Raises</h5>
<p>Exception: <em>description</em></p>
<h5 id="model.federated_model.FederatedModel.update_weights--returns">Returns</h5>
<p>None</p>

            <details class="quote">
              <summary>Source code in <code>EFL\model\federated_model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_weights</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> 
    <span class="n">avg_tensors</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Updates the weights of the network stored on client with passed tensors.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    avg_tensors: Ordered_Dict</span>
<span class="sd">        An Ordered Dictionary containing a averaged tensors</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exception: _description_</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">avg_tensors</span><span class="p">),</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="node.federated_node"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="node.federated_node.FederatedNode" class="doc doc-heading">
            <code>FederatedNode</code>


</h2>


    <div class="doc doc-contents ">


              <details class="quote">
                <summary>Source code in <code>EFL\node\federated_node.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">FederatedNode</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;An abstract object representing a single node in the federated training.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="nf">connect_data_id</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">node_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">FederatedModel</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">orchestrator</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attaches dataset and id to a node, creating an individualised version.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        node_id: int | str</span>
<span class="sd">            ID of the node</span>
<span class="sd">        model: FederatedModel</span>
<span class="sd">            FederatedModel template that should be copied and attached to the node</span>
<span class="sd">        data: Any</span>
<span class="sd">            Data to be attached to a FederatedModel.</span>
<span class="sd">        orchestrator: bool (default to False)</span>
<span class="sd">            Boolean flag if the node is belonging to the orchestrator</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">node_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">attach_dataset_id</span><span class="p">(</span>
            <span class="n">local_dataset</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">node_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">,</span>
            <span class="n">only_test</span><span class="o">=</span><span class="n">orchestrator</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">get_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extended API call to recover model weights. Causes the same effect as calling</span>
<span class="sd">        node.model.get_weigts()</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>
<span class="sd">        Returns</span>
<span class="sd">        OrderedDict</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">update_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">weights</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extended API call to update model. Causes the same effect as calling</span>
<span class="sd">        node.model.update_weights()</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        weights:OrderedDict</span>
<span class="sd">            OrderedDict to be uploaded onto the model.</span>
<span class="sd">        Returns</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">train_local_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                          <span class="n">local_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                          <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span>
                          <span class="n">save_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                          <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This function starts the server phase of the federated learning.</span>
<span class="sd">        In particular, it trains the model locally and then sends the weights.</span>
<span class="sd">        Then the updated weights are received and used to update</span>
<span class="sd">        the global model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        node: FederatedNode </span>
<span class="sd">            Node that we want to train.</span>
<span class="sd">        iteration: int</span>
<span class="sd">            Current global iteration</span>
<span class="sd">        local_epochs: int</span>
<span class="sd">            Number of local epochs for which the node should be training.</span>
<span class="sd">        mode: str (default to &#39;weights&#39;)</span>
<span class="sd">            Mode = &#39;weights&#39;: Node will return model&#39;s weights.</span>
<span class="sd">            Mode = &#39;gradients&#39;: Node will return model&#39;s gradients.</span>
<span class="sd">        save_model: bool (default to False)</span>
<span class="sd">            Boolean flag to save a model.</span>
<span class="sd">        save_path: str (defualt to None)</span>
<span class="sd">            Path object used to save a model</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            Tuple[int, OrderedDict, List[float], List[float]]:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">node_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2"> | NODE </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="si">}</span><span class="s2">] Starting training on node </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">loss_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">accuracy_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># If mode is set to &quot;gradients&quot; -&gt; preserve a local model to calculate gradients</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;gradients&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">preserve_initial_model</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">local_epochs</span><span class="p">):</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_training</span><span class="p">(</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span> 
                <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span>
                <span class="p">)</span>
            <span class="n">loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">])</span>
            <span class="n">accuracy_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">save_model</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">iteration</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">store_model_on_disk</span><span class="p">(</span>
                    <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span> 
                    <span class="n">path</span><span class="o">=</span><span class="n">save_path</span>
                    <span class="p">)</span>
        <span class="n">node_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2"> | NODE </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="si">}</span><span class="s2">] Results of training on node </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">accuracy_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;weights&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(),</span>
                <span class="n">loss_list</span><span class="p">,</span>
                <span class="n">accuracy_list</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;gradients&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_gradients</span><span class="p">(),</span>
                <span class="n">loss_list</span><span class="p">,</span>
                <span class="n">accuracy_list</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">local_training</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                       <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span>
                       <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method for performing one epoch of local training.</span>
<span class="sd">        Performs one round of Federated Training and pack the</span>
<span class="sd">        results (metrics) into the appropiate data structure.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            dict[int, int]: metrics from the training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span> <span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="node.federated_node.FederatedNode.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>An abstract object representing a single node in the federated training.</p>
<h5 id="node.federated_node.FederatedNode.__init__--parameters">Parameters</h5>
<p>None
Returns</p>
<hr />
<p>None</p>

            <details class="quote">
              <summary>Source code in <code>EFL\node\federated_node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An abstract object representing a single node in the federated training.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    None</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="node.federated_node.FederatedNode.connect_data_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">connect_data_id</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">orchestrator</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Attaches dataset and id to a node, creating an individualised version.</p>
<h5 id="node.federated_node.FederatedNode.connect_data_id--parameters">Parameters</h5>
<p>node_id: int | str
    ID of the node
model: FederatedModel
    FederatedModel template that should be copied and attached to the node
data: Any
    Data to be attached to a FederatedModel.
orchestrator: bool (default to False)
    Boolean flag if the node is belonging to the orchestrator
Returns</p>
<hr />
<p>None</p>

            <details class="quote">
              <summary>Source code in <code>EFL\node\federated_node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">connect_data_id</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">node_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">FederatedModel</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">orchestrator</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Attaches dataset and id to a node, creating an individualised version.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    node_id: int | str</span>
<span class="sd">        ID of the node</span>
<span class="sd">    model: FederatedModel</span>
<span class="sd">        FederatedModel template that should be copied and attached to the node</span>
<span class="sd">    data: Any</span>
<span class="sd">        Data to be attached to a FederatedModel.</span>
<span class="sd">    orchestrator: bool (default to False)</span>
<span class="sd">        Boolean flag if the node is belonging to the orchestrator</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">node_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">attach_dataset_id</span><span class="p">(</span>
        <span class="n">local_dataset</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="n">node_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">,</span>
        <span class="n">only_test</span><span class="o">=</span><span class="n">orchestrator</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="node.federated_node.FederatedNode.get_weights" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_weights</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Extended API call to recover model weights. Causes the same effect as calling
node.model.get_weigts()
Parameters</p>
<hr />
<p>None
Returns
OrderedDict
None</p>

            <details class="quote">
              <summary>Source code in <code>EFL\node\federated_node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extended API call to recover model weights. Causes the same effect as calling</span>
<span class="sd">    node.model.get_weigts()</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    None</span>
<span class="sd">    Returns</span>
<span class="sd">    OrderedDict</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="node.federated_node.FederatedNode.local_training" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">local_training</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Helper method for performing one epoch of local training.
Performs one round of Federated Training and pack the
results (metrics) into the appropiate data structure.</p>
<h5 id="node.federated_node.FederatedNode.local_training--parameters">Parameters</h5>
<h5 id="node.federated_node.FederatedNode.local_training--returns">Returns</h5>
<pre><code>dict[int, int]: metrics from the training.
</code></pre>

            <details class="quote">
              <summary>Source code in <code>EFL\node\federated_node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">local_training</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span>
                   <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper method for performing one epoch of local training.</span>
<span class="sd">    Performs one round of Federated Training and pack the</span>
<span class="sd">    results (metrics) into the appropiate data structure.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        dict[int, int]: metrics from the training.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loss</span><span class="p">,</span> <span class="n">accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span> <span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="node.federated_node.FederatedNode.train_local_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train_local_model</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">local_epochs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;weights&#39;</span><span class="p">,</span> <span class="n">save_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>This function starts the server phase of the federated learning.
In particular, it trains the model locally and then sends the weights.
Then the updated weights are received and used to update
the global model.</p>
<h5 id="node.federated_node.FederatedNode.train_local_model--parameters">Parameters</h5>
<p>node: FederatedNode 
    Node that we want to train.
iteration: int
    Current global iteration
local_epochs: int
    Number of local epochs for which the node should be training.
mode: str (default to 'weights')
    Mode = 'weights': Node will return model's weights.
    Mode = 'gradients': Node will return model's gradients.
save_model: bool (default to False)
    Boolean flag to save a model.
save_path: str (defualt to None)
    Path object used to save a model</p>
<h5 id="node.federated_node.FederatedNode.train_local_model--returns">Returns</h5>
<pre><code>Tuple[int, OrderedDict, List[float], List[float]]:
</code></pre>

            <details class="quote">
              <summary>Source code in <code>EFL\node\federated_node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train_local_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                      <span class="n">local_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                      <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span>
                      <span class="n">save_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                      <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function starts the server phase of the federated learning.</span>
<span class="sd">    In particular, it trains the model locally and then sends the weights.</span>
<span class="sd">    Then the updated weights are received and used to update</span>
<span class="sd">    the global model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    node: FederatedNode </span>
<span class="sd">        Node that we want to train.</span>
<span class="sd">    iteration: int</span>
<span class="sd">        Current global iteration</span>
<span class="sd">    local_epochs: int</span>
<span class="sd">        Number of local epochs for which the node should be training.</span>
<span class="sd">    mode: str (default to &#39;weights&#39;)</span>
<span class="sd">        Mode = &#39;weights&#39;: Node will return model&#39;s weights.</span>
<span class="sd">        Mode = &#39;gradients&#39;: Node will return model&#39;s gradients.</span>
<span class="sd">    save_model: bool (default to False)</span>
<span class="sd">        Boolean flag to save a model.</span>
<span class="sd">    save_path: str (defualt to None)</span>
<span class="sd">        Path object used to save a model</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        Tuple[int, OrderedDict, List[float], List[float]]:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">node_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2"> | NODE </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="si">}</span><span class="s2">] Starting training on node </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">loss_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">accuracy_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># If mode is set to &quot;gradients&quot; -&gt; preserve a local model to calculate gradients</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;gradients&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">preserve_initial_model</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">local_epochs</span><span class="p">):</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_training</span><span class="p">(</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span> 
            <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span>
            <span class="p">)</span>
        <span class="n">loss_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">])</span>
        <span class="n">accuracy_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">save_model</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">iteration</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">store_model_on_disk</span><span class="p">(</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span> 
                <span class="n">path</span><span class="o">=</span><span class="n">save_path</span>
                <span class="p">)</span>
    <span class="n">node_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2"> | NODE </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="si">}</span><span class="s2">] Results of training on node </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">accuracy_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;weights&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(),</span>
            <span class="n">loss_list</span><span class="p">,</span>
            <span class="n">accuracy_list</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;gradients&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_gradients</span><span class="p">(),</span>
            <span class="n">loss_list</span><span class="p">,</span>
            <span class="n">accuracy_list</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="node.federated_node.FederatedNode.update_weights" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Extended API call to update model. Causes the same effect as calling
node.model.update_weights()
Parameters</p>
<hr />
<p>weights:OrderedDict
    OrderedDict to be uploaded onto the model.
Returns
None</p>

            <details class="quote">
              <summary>Source code in <code>EFL\node\federated_node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">weights</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extended API call to update model. Causes the same effect as calling</span>
<span class="sd">    node.model.update_weights()</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights:OrderedDict</span>
<span class="sd">        OrderedDict to be uploaded onto the model.</span>
<span class="sd">    Returns</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="simulation.simulation"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="simulation.simulation.Simulation" class="doc doc-heading">
            <code>Simulation</code>


</h2>


    <div class="doc doc-contents ">


        <p>Simulation class representing a generic simulation type.</p>
<h4 id="simulation.simulation.Simulation--attributes">Attributes</h4>
<p>model_template : FederatedModel
    Initialized instance of a Federated Model class that is uploaded to every client.
node_template : FederatedNode
    Initialized instance of a Federated Node class that is used to simulate nodes.
data : dict
    Local data used for the training in a dictionary format, mapping each client to its respective dataset.</p>

              <details class="quote">
                <summary>Source code in <code>EFL\simulation\simulation.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  34</span>
<span class="normal">  35</span>
<span class="normal">  36</span>
<span class="normal">  37</span>
<span class="normal">  38</span>
<span class="normal">  39</span>
<span class="normal">  40</span>
<span class="normal">  41</span>
<span class="normal">  42</span>
<span class="normal">  43</span>
<span class="normal">  44</span>
<span class="normal">  45</span>
<span class="normal">  46</span>
<span class="normal">  47</span>
<span class="normal">  48</span>
<span class="normal">  49</span>
<span class="normal">  50</span>
<span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Simulation</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulation class representing a generic simulation type.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        model_template : FederatedModel</span>
<span class="sd">            Initialized instance of a Federated Model class that is uploaded to every client.</span>
<span class="sd">        node_template : FederatedNode</span>
<span class="sd">            Initialized instance of a Federated Node class that is used to simulate nodes.</span>
<span class="sd">        data : dict</span>
<span class="sd">            Local data used for the training in a dictionary format, mapping each client to its respective dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">model_template</span><span class="p">:</span> <span class="n">FederatedModel</span><span class="p">,</span>
        <span class="n">node_template</span><span class="p">:</span> <span class="n">FederatedNode</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creating simulation instant requires providing an already created instance of model template</span>
<span class="sd">        and node template. Those instances then will be copied n-times to create n different nodes, each</span>
<span class="sd">        with a different dataset. Additionally, a data for local nodes should be passed in form of a dictionary,</span>
<span class="sd">        maping dataset to each respective client.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_template : FederatedModel</span>
<span class="sd">            Initialized instance of a Federated Model class that will be uploaded to every client.</span>
<span class="sd">        node_template : FederatedNode</span>
<span class="sd">            Initialized instance of a Federated Node class that will be used to simulate nodes.</span>
<span class="sd">        seed : int,</span>
<span class="sd">            Seed for the simulation, default to 42</span>
<span class="sd">        **kwargs : dict, optional</span>
<span class="sd">            Extra arguments to enable selected features of the Orchestrator.</span>
<span class="sd">            passing full_debug to **kwargs, allow to enter a full debug mode.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_template</span> <span class="o">=</span> <span class="n">model_template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_template</span> <span class="o">=</span> <span class="n">node_template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flattened_model_length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters_namespace</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">,</span>
                                   <span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">attach_orchestrator_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">orchestrator_data</span><span class="p">:</span> <span class="n">Any</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attaches model of the orchestrator that is saved as an instance attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orchestrator_data: Any </span>
<span class="sd">            Orchestrator data that should be attached to the orchestrator model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_template</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="o">.</span><span class="n">attach_dataset_id</span><span class="p">(</span><span class="n">local_dataset</span><span class="o">=</span><span class="p">[</span><span class="n">orchestrator_data</span><span class="p">],</span>
                                                  <span class="n">node_name</span><span class="o">=</span><span class="s1">&#39;orchestrator&#39;</span><span class="p">,</span>
                                                  <span class="n">only_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">attach_node_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">nodes_data</span><span class="p">:</span> <span class="nb">dict</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attaches models of the nodes to the simulation instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orchestrator_data: Any</span>
<span class="sd">            Orchestrator data that should be attached to nodes models.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">nodes_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_template</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span><span class="o">.</span><span class="n">connect_data_id</span><span class="p">(</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">node_id</span><span class="p">,</span>
                                                  <span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_template</span><span class="p">),</span>
                                                  <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># Calculting the length of the model -&gt; for creating similarity matrix</span>
        <span class="n">flattened_model</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">))]</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">flattened_model</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">flattened_model_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flattened_model</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">train_epoch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sampled_nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">:</span> <span class="n">FederatedNode</span><span class="p">],</span>
        <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">local_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span>
        <span class="n">save_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_job</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs one training round of a federated learning. Returns training</span>
<span class="sd">        results upon completion.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        samples_nodes: dict[int: FederatedNode]</span>
<span class="sd">            Dictionary containing sampled Federated Nodes</span>
<span class="sd">        iteration: int</span>
<span class="sd">            Current global iteration of the training process</span>
<span class="sd">        local_epochs: int</span>
<span class="sd">            Number of local epochs for which the local model should</span>
<span class="sd">            be trained.</span>
<span class="sd">        mode: str (default to &#39;weights&#39;)</span>
<span class="sd">            Mode = &#39;weights&#39;: Node will return model&#39;s weights.</span>
<span class="sd">            Mode = &#39;gradients&#39;: Node will return model&#39;s gradients.</span>
<span class="sd">        save_model: bool (default to False)</span>
<span class="sd">            Boolean flag to save a model.</span>
<span class="sd">        save_path: str (defualt to None)</span>
<span class="sd">            Path object used to save a model</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[dict[int, int, float, float, list, list], dict[int, OrderedDict]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">training_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">batch_job</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">chunker_dict</span><span class="p">(</span><span class="n">sampled_nodes</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">))</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">train_nodes</span><span class="p">,</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">local_epochs</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">save_model</span><span class="p">,</span> <span class="n">save_path</span><span class="p">))</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>
                    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                        <span class="n">node_id</span><span class="p">,</span> <span class="n">model_weights</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">,</span> <span class="n">accuracy_list</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                        <span class="n">weights</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_weights</span>
                        <span class="n">training_results</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">iteration</span><span class="p">,</span>
                            <span class="s2">&quot;node_id&quot;</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span>
                            <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> 
                            <span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="n">accuracy_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                            <span class="s2">&quot;full_loss&quot;</span><span class="p">:</span> <span class="n">loss_list</span><span class="p">,</span>
                            <span class="s2">&quot;full_accuracy&quot;</span><span class="p">:</span> <span class="n">accuracy_list</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sampled_nodes</span><span class="p">))</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">train_nodes</span><span class="p">,</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">local_epochs</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">save_model</span><span class="p">,</span> <span class="n">save_path</span><span class="p">))</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sampled_nodes</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="n">node_id</span><span class="p">,</span> <span class="n">model_weights</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">,</span> <span class="n">accuracy_list</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="n">weights</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_weights</span>
                    <span class="n">training_results</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">iteration</span><span class="p">,</span>
                        <span class="s2">&quot;node_id&quot;</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span>
                        <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> 
                        <span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="n">accuracy_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s2">&quot;full_loss&quot;</span><span class="p">:</span> <span class="n">loss_list</span><span class="p">,</span>
                        <span class="s2">&quot;full_accuracy&quot;</span><span class="p">:</span> <span class="n">accuracy_list</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">training_results</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">no_clustering</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">gradients</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">,</span>
        <span class="n">sim_mat_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">temperature_save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">] CLUSTERING PROCEDURE: NO CLUSTERING&quot;</span><span class="p">)</span>
        <span class="c1"># Step I: Loop over all clusters of iteration = iteration</span>
        <span class="n">loop_current_clusters_keys</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="c1"># Copy obj for iterating</span>
        <span class="k">for</span> <span class="n">cluster_signature</span> <span class="ow">in</span> <span class="n">loop_current_clusters_keys</span><span class="p">:</span>
            <span class="c1"># Define a new name of </span>
            <span class="c1"># cluster: signature+in_cluster_nodes</span>
            <span class="n">cluster_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cluster_signature</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
            <span class="c1"># Collect in-cluster gradients</span>
            <span class="n">in_cluster_gradients</span> <span class="o">=</span> <span class="n">select_gradients</span><span class="p">(</span>
                <span class="n">nodes_id_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>
                <span class="n">gradients</span><span class="o">=</span><span class="n">gradients</span>
            <span class="p">)</span>
            <span class="c1"># Creating matrix of appended gradients</span>
            <span class="n">in_cluster_gradients_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">in_cluster_gradients</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">flattened_model_length</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ind_gradients</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">in_cluster_gradients</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="c1"># Flatenning model</span>
                <span class="n">flattened_model</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ind_gradients</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">flattened_model</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="n">in_cluster_gradients_matrix</span><span class="p">[</span><span class="n">pos</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flattened_model</span><span class="p">)</span>
            <span class="c1"># Calculating Cosine Distance</span>
            <span class="n">cosdist_mat</span> <span class="o">=</span> <span class="n">calculate_cosine_dist</span><span class="p">(</span><span class="n">in_cluster_gradients_matrix</span><span class="p">)</span>
            <span class="c1"># Save matrix of cosine distance</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sim_mat_savepath</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cluster_of_</span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1">_at_</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cosdist_mat</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">temperature</span> <span class="o">=</span> <span class="n">calculate_temperature</span><span class="p">(</span><span class="n">cosdist_mat</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temperature_save_path</span><span class="p">,</span> <span class="s1">&#39;clusters_temperature.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;a+&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">temperature</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">energy_oneshot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">clustering_algorithm</span> <span class="p">:</span> <span class="n">cluster</span><span class="p">,</span>
        <span class="n">last_temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">gradients</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">,</span>
        <span class="n">sim_mat_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">temperature_save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">clustering_shot</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">] CLUSTERING PROCEDURE: ONESHOT CLUSTERING&quot;</span><span class="p">)</span>
        <span class="c1"># Step I: Loop over all clusters of iteration = iteration</span>
        <span class="n">loop_current_clusters_keys</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="c1"># Copy obj for iteratin</span>
        <span class="k">for</span> <span class="n">cluster_signature</span> <span class="ow">in</span> <span class="n">loop_current_clusters_keys</span><span class="p">:</span>
            <span class="c1"># Define a new name: signature+in_cluster_nodes</span>
            <span class="n">cluster_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cluster_signature</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
            <span class="c1"># Collect in-cluster gradients</span>
            <span class="n">in_cluster_gradients</span> <span class="o">=</span> <span class="n">select_gradients</span><span class="p">(</span>
                <span class="n">nodes_id_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>
                <span class="n">gradients</span><span class="o">=</span><span class="n">gradients</span>
            <span class="p">)</span>
            <span class="c1"># Creating matrix of appended gradients</span>
            <span class="n">in_cluster_gradients_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">in_cluster_gradients</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">flattened_model_length</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ind_gradients</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">in_cluster_gradients</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="c1"># Flatenning model</span>
                <span class="n">flattened_model</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ind_gradients</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">flattened_model</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="n">in_cluster_gradients_matrix</span><span class="p">[</span><span class="n">pos</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flattened_model</span><span class="p">)</span>
            <span class="c1"># Calculating Cosine Distance</span>
            <span class="n">cosdist_mat</span> <span class="o">=</span> <span class="n">calculate_cosine_dist</span><span class="p">(</span><span class="n">in_cluster_gradients_matrix</span><span class="p">)</span>
            <span class="c1"># Save matrix of cosine distance</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sim_mat_savepath</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cluster_of_</span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1">_at_</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cosdist_mat</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="c1"># Calculating matrix temperature           </span>
            <span class="n">temperature</span> <span class="o">=</span> <span class="n">calculate_temperature</span><span class="p">(</span><span class="n">cosdist_mat</span><span class="p">)</span>
            <span class="c1"># Save matrix temperature</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temperature_save_path</span><span class="p">,</span> <span class="s1">&#39;clusters_temperature.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;a+&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cluster_signature</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">temperature</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">] Last Temperature: </span><span class="si">{</span><span class="n">last_temperature</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">] Current Temperature: </span><span class="si">{</span><span class="n">temperature</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Step II: Check if clustering was already performed - if yes, skip the clustering part and return True</span>
            <span class="k">if</span> <span class="n">clustering_shot</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="c1"># Step III: If temperature exceeds minimum perform clustering</span>
                <span class="k">if</span> <span class="n">temperature</span> <span class="o">&gt;</span> <span class="n">last_temperature</span><span class="p">:</span>
                    <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">] Raise in temperature detected, performing clustering&quot;</span><span class="p">)</span>
                    <span class="c1"># Using clustering algorithm</span>
                    <span class="n">clustering_algorithm</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">cosdist_mat</span><span class="p">)</span>
                    <span class="n">new_clusters_info</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># Adding children to the current clustering structure</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Preparing to add children to the cluster</span>
                    <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">new_signature</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">clustering_algorithm</span><span class="o">.</span><span class="n">labels_</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters_namespace</span><span class="p">):</span>
                        <span class="n">new_clusters_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cluster_signature</span><span class="si">}{</span><span class="n">new_signature</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">new_clusters_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_clusters_name</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">new_clusters_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cluster_Structure</span><span class="p">(</span>
                            <span class="n">population</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clustering_algorithm</span><span class="o">.</span><span class="n">labels_</span><span class="o">==</span><span class="n">label</span><span class="p">)],</span>
                            <span class="n">model</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">),</span>
                            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                            <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">new_clusters_name</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">[</span><span class="n">new_clusters_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">new_clusters_name</span><span class="p">]</span>
                    <span class="c1"># Adding old cluster to a set of all clusters</span>
                    <span class="c1"># Deleting old cluster from a set of current clusters</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span>
                    <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">] Cluster of </span><span class="si">{</span><span class="n">cluster_signature</span><span class="si">}</span><span class="s2"> was partitioned into </span><span class="si">{</span><span class="n">new_clusters_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># Extending next iteration structure by the current children, returning True (&#39;shot fired&#39;)</span>
                    <span class="c1"># Saving the cluster</span>
                    <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Else returning False (&#39;shot not fired&#39;)</span>
                    <span class="c1"># # if T &lt;= T_min, we just carry on the cluster to the next entry.</span>
                    <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">temperature</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Do not change the clustering structure</span>
                <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">briggs_hierarchical</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">gradients</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">,</span>
        <span class="n">sim_mat_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">distance_threshold</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">):</span>
        <span class="n">clustering_algorithm</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;precomputed&#39;</span><span class="p">,</span> <span class="n">distance_threshold</span><span class="o">=</span><span class="n">distance_threshold</span><span class="p">,</span>
                                                       <span class="n">linkage</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">)</span>
        <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">] CLUSTERING PROCEDURE: BRIGGS CLUSTERING&quot;</span><span class="p">)</span>
        <span class="c1"># Step I: Loop over all clusters of iteration = iteration</span>
        <span class="n">loop_current_clusters_keys</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="c1"># Copy obj for iterating</span>
        <span class="k">for</span> <span class="n">cluster_signature</span> <span class="ow">in</span> <span class="n">loop_current_clusters_keys</span><span class="p">:</span>
            <span class="n">cluster_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cluster_signature</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
            <span class="c1"># Collect in-cluster gradients</span>
            <span class="n">in_cluster_gradients</span> <span class="o">=</span> <span class="n">select_gradients</span><span class="p">(</span>
                <span class="n">nodes_id_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>
                <span class="n">gradients</span><span class="o">=</span><span class="n">gradients</span>
            <span class="p">)</span>
            <span class="c1"># Creating matrix of appended gradients</span>
            <span class="n">in_cluster_gradients_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">in_cluster_gradients</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">flattened_model_length</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ind_gradients</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">in_cluster_gradients</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="c1"># Flatenning model</span>
                <span class="n">flattened_model</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ind_gradients</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">flattened_model</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="n">in_cluster_gradients_matrix</span><span class="p">[</span><span class="n">pos</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flattened_model</span><span class="p">)</span>
            <span class="c1"># Calculating Cosine Similarity</span>
            <span class="n">cossim_mat</span> <span class="o">=</span> <span class="n">calculate_cosine_similarity</span><span class="p">(</span><span class="n">in_cluster_gradients_matrix</span><span class="p">)</span>
            <span class="c1"># Save matrix of cosine similarity</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sim_mat_savepath</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cluster_of_</span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1">_at_</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cossim_mat</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="c1"># Step III: </span>
            <span class="c1"># Using clustering algorithm</span>
            <span class="n">clustering_algorithm</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">cossim_mat</span><span class="p">)</span>
            <span class="n">new_clusters_info</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Adding children to the current clustering structure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Preparing to add children to the cluster</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">new_signature</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">clustering_algorithm</span><span class="o">.</span><span class="n">labels_</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters_namespace</span><span class="p">):</span>
                <span class="n">new_clusters_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cluster_signature</span><span class="si">}{</span><span class="n">new_signature</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">new_clusters_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_clusters_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">new_clusters_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cluster_Structure</span><span class="p">(</span>
                    <span class="n">population</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clustering_algorithm</span><span class="o">.</span><span class="n">labels_</span><span class="o">==</span><span class="n">label</span><span class="p">)],</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">),</span>
                    <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                    <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">new_clusters_name</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">[</span><span class="n">new_clusters_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">new_clusters_name</span><span class="p">]</span>
            <span class="c1"># Adding old cluster to a set of all clusters</span>
            <span class="c1"># Deleting old cluster from a set of current clusters</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span>
            <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">] Cluster of </span><span class="si">{</span><span class="n">cluster_signature</span><span class="si">}</span><span class="s2"> was partitioned into </span><span class="si">{</span><span class="n">new_clusters_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Extending next iteration structure by the current children, returning True (&#39;shot fired&#39;)</span>
            <span class="c1"># Saving the cluster</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">sattler_clustering</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">gradients</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">,</span>
        <span class="n">sim_mat_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">EPS_1</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">EPS_2</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">round_cooldown</span><span class="p">:</span><span class="nb">int</span>
    <span class="p">):</span>
        <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">] CLUSTERING PROCEDURE: SATTLER CLUSTERING&quot;</span><span class="p">)</span>
        <span class="c1"># Step I: Loop over all clusters of iteration = iteration</span>
        <span class="n">loop_current_clusters_keys</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="c1"># Copy obj for iteratin</span>
        <span class="k">for</span> <span class="n">cluster_signature</span> <span class="ow">in</span> <span class="n">loop_current_clusters_keys</span><span class="p">:</span>
            <span class="n">cluster_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cluster_signature</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
            <span class="c1"># Collect in-cluster gradients</span>
            <span class="n">in_cluster_gradients</span> <span class="o">=</span> <span class="n">select_gradients</span><span class="p">(</span>
                <span class="n">nodes_id_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>
                <span class="n">gradients</span><span class="o">=</span><span class="n">gradients</span>
            <span class="p">)</span>
            <span class="n">in_cluster_gradients_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">in_cluster_gradients</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">flattened_model_length</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ind_gradients</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">in_cluster_gradients</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="c1"># Flatenning model</span>
                <span class="n">flattened_model</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ind_gradients</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">flattened_model</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="n">in_cluster_gradients_matrix</span><span class="p">[</span><span class="n">pos</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flattened_model</span><span class="p">)</span>
            <span class="n">cossim_mat</span> <span class="o">=</span> <span class="n">calculate_cosine_similarity</span><span class="p">(</span><span class="n">in_cluster_gradients_matrix</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sim_mat_savepath</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cluster_of_</span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="s1">_at_</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cossim_mat</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">max_norm</span> <span class="o">=</span> <span class="n">compute_max_update_norm</span><span class="p">(</span><span class="n">in_cluster_gradients_matrix</span><span class="p">)</span>
            <span class="n">mean_norm</span> <span class="o">=</span> <span class="n">compute_mean_update_norm</span><span class="p">(</span><span class="n">in_cluster_gradients_matrix</span><span class="p">)</span>
            <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">] Mean norm: </span><span class="si">{</span><span class="n">mean_norm</span><span class="si">}</span><span class="s2">, max norm: </span><span class="si">{</span><span class="n">max_norm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mean_norm</span> <span class="o">&lt;</span> <span class="n">EPS_1</span> <span class="ow">and</span> <span class="n">max_norm</span> <span class="o">&gt;</span> <span class="n">EPS_2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="n">round_cooldown</span><span class="p">:</span>
                <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">] Clustering criterions met, perform clustering.&quot;</span><span class="p">)</span>
                <span class="n">clustering_algorithm</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;precomputed&#39;</span><span class="p">,</span> <span class="n">linkage</span> <span class="o">=</span><span class="s1">&#39;complete&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">-</span><span class="n">cossim_mat</span><span class="p">)</span>
                <span class="n">new_clusters_info</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># Adding children to the current clustering structure</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Preparing to add children to the cluster</span>
                <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">new_signature</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">clustering_algorithm</span><span class="o">.</span><span class="n">labels_</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters_namespace</span><span class="p">):</span>
                    <span class="n">new_clusters_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cluster_signature</span><span class="si">}{</span><span class="n">new_signature</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">new_clusters_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_clusters_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">new_clusters_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cluster_Structure</span><span class="p">(</span>
                        <span class="n">population</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clustering_algorithm</span><span class="o">.</span><span class="n">labels_</span><span class="o">==</span><span class="n">label</span><span class="p">)],</span>
                        <span class="n">model</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">),</span>
                        <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                        <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">new_clusters_name</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">[</span><span class="n">new_clusters_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">new_clusters_name</span><span class="p">]</span>
                    <span class="c1"># Adding old cluster to a set of all clusters</span>
                    <span class="c1"># Deleting old cluster from a set of current clusters</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span>
                <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">] Cluster of </span><span class="si">{</span><span class="n">cluster_signature</span><span class="si">}</span><span class="s2"> was partitioned into </span><span class="si">{</span><span class="n">new_clusters_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">training_protocol_energy_oneshot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">iterations</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">local_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">aggrgator</span><span class="p">:</span> <span class="n">Aggregator</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">clustering_algorithm</span><span class="p">:</span> <span class="n">cluster</span><span class="p">,</span>
        <span class="n">metrics_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">nodes_models_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">orchestrator_models_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">sim_matrices_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cluster_structure_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">skip_calculation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">batch_job</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs a full federated training according to the initialized</span>
<span class="sd">        settings. The train_protocol of the generic_orchestrator.Orchestrator</span>
<span class="sd">        follows a classic FedOpt algorithm - it averages the local gradients </span>
<span class="sd">        and aggregates them using a selected optimizer.</span>
<span class="sd">        SOURCE: </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        iterations: int</span>
<span class="sd">            Number of (global) iterations // epochs to train the models for.</span>
<span class="sd">        sample_size: int</span>
<span class="sd">            Size of the sample</span>
<span class="sd">        local_epochs: int</span>
<span class="sd">            Number of local epochs for which the local model should</span>
<span class="sd">            be trained.</span>
<span class="sd">        aggregator: Aggregator</span>
<span class="sd">            Instance of the Aggregator object that will be used to aggregate the result each round</span>
<span class="sd">        learning_rate: float</span>
<span class="sd">            Learning rate to be used for optimization.</span>
<span class="sd">        metrics_savepath: str</span>
<span class="sd">            Path for saving the metrics</span>
<span class="sd">        nodes_models_savepath: str</span>
<span class="sd">            Path for saving the models in the .pt format.</span>
<span class="sd">        orchestrator_models_savepath: str</span>
<span class="sd">            Path for saving the orchestrator models.</span>
<span class="sd">        clustering_root_savepath: str</span>
<span class="sd">            Path for saving all the clustering results (general).</span>
<span class="sd">        sim_matrices_savepath: str</span>
<span class="sd">            Path for saving all the similarity matrices.</span>
<span class="sd">        cluster_structure_savepath: str</span>
<span class="sd">            Path for saving all the cluster structures.</span>
<span class="sd">        skip_calculation: bool</span>
<span class="sd">            If set to True, will caculate Cosine Distance / Similarity values only when clustering.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Returns 0 on the successful completion of the training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Step I: Create first cluster (the whole population)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">Cluster_Structure</span><span class="p">(</span>
            <span class="n">population</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">]),</span> <span class="c1"># First cluster, all nodes belonging to it.</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()),</span> <span class="c1"># Model for the first cluster, direct copy of the central orchestrator model.</span>
            <span class="n">iteration</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># Created During the First Iteration</span>
        <span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]}</span> <span class="c1"># List of all clusters that were created during the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span> <span class="c1"># mapping between iteration: {node: cluster_id}</span>

        <span class="c1"># Step II: Setting the &#39;clustering shot&#39; flag to False</span>
        <span class="n">clustering_shot</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">last_temperature</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

        <span class="c1"># Step III: Looping over the iterations</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>            
            <span class="c1"># Sampling nodes</span>
            <span class="n">sampled_nodes</span> <span class="o">=</span> <span class="n">sample_nodes</span><span class="p">(</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                <span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span><span class="p">,</span>
                <span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span>
            <span class="p">)</span>

            <span class="c1"># Step IV: Training nodes</span>
            <span class="n">training_results</span><span class="p">,</span> <span class="n">gradients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_epoch</span><span class="p">(</span>
                <span class="n">sampled_nodes</span><span class="o">=</span><span class="n">sampled_nodes</span><span class="p">,</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">local_epochs</span><span class="o">=</span><span class="n">local_epochs</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;gradients&#39;</span><span class="p">,</span>
                <span class="n">save_model</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">nodes_models_savepath</span><span class="p">,</span>
                <span class="n">batch_job</span><span class="o">=</span><span class="n">batch_job</span>
            <span class="p">)</span>
            <span class="c1"># Preserving metrics of the training</span>
            <span class="n">save_nested_dict_ascsv</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">training_results</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s1">&#39;training_metrics.csv&#39;</span><span class="p">))</span>
            <span class="c1"># Testing nodes on the local dataset before the model update (only sampled nodes).</span>
            <span class="n">automatic_node_evaluation</span><span class="p">(</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">nodes</span><span class="o">=</span><span class="n">sampled_nodes</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;before_update_metrics.csv&quot;</span><span class="p">))</span>
                        <span class="c1"># Evaluating the generalizability of the local model</span>
            <span class="n">automatic_generalizability_evaluation</span><span class="p">(</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                <span class="n">general_model</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="p">),</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;after_update_generalizability.csv&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># If clustering was performed before and we want to skip saving cosdist mat</span>
            <span class="k">if</span> <span class="n">clustering_shot</span> <span class="ow">and</span> <span class="n">skip_calculation</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c1"># Do not change the self.current_clusters architecture</span>
            <span class="c1"># Else perform a full procedure</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Clustering</span>
                <span class="n">clustering_shot</span><span class="p">,</span> <span class="n">last_temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_oneshot</span><span class="p">(</span>
                    <span class="n">clustering_algorithm</span> <span class="o">=</span> <span class="n">clustering_algorithm</span><span class="p">,</span>
                    <span class="n">last_temperature</span> <span class="o">=</span> <span class="n">last_temperature</span><span class="p">,</span>
                    <span class="n">iteration</span> <span class="o">=</span> <span class="n">iteration</span><span class="p">,</span>
                    <span class="n">gradients</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">gradients</span><span class="p">),</span>
                    <span class="n">sim_mat_savepath</span> <span class="o">=</span> <span class="n">sim_matrices_savepath</span><span class="p">,</span>
                    <span class="n">temperature_save_path</span> <span class="o">=</span> <span class="n">metrics_savepath</span><span class="p">,</span>
                    <span class="n">clustering_shot</span> <span class="o">=</span> <span class="n">clustering_shot</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">[</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">loop_current_clusters_keys</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="c1"># Copy obj for iterating # Copy obj for iterating</span>
            <span class="c1"># Step V: In-cluster aggregation</span>
            <span class="k">for</span> <span class="n">cluster_signature</span> <span class="ow">in</span> <span class="n">loop_current_clusters_keys</span><span class="p">:</span>
                <span class="c1"># Collect in-cluster gradients</span>
                <span class="n">in_cluster_gradients</span> <span class="o">=</span> <span class="n">select_gradients</span><span class="p">(</span>
                <span class="n">nodes_id_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>
                <span class="n">gradients</span><span class="o">=</span><span class="n">gradients</span>
                <span class="p">)</span>
                <span class="n">avg_incluster_gradients</span> <span class="o">=</span> <span class="n">average_of_weigts</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">in_cluster_gradients</span><span class="p">))</span>
                <span class="c1"># Updating weights</span>
                <span class="n">new_incluster_weights</span> <span class="o">=</span> <span class="n">aggrgator</span><span class="o">.</span><span class="n">optimize_weights</span><span class="p">(</span>
                    <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                    <span class="n">gradients</span> <span class="o">=</span> <span class="n">avg_incluster_gradients</span><span class="p">,</span>
                    <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Update weights of the cluster model</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_incluster_weights</span><span class="p">)</span>
                <span class="c1"># Updating weights for each node in the cluster</span>
                <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">node_id</span> <span class="o">==</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">new_incluster_weights</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_signature</span>

            <span class="c1"># # Step VI: Mixing the global model</span>
            <span class="c1"># avg_global_gradients = average_of_weigts(gradients)</span>
            <span class="c1"># # Updating the weights for the central model</span>
            <span class="c1"># new_global_weights = aggrgator.optimize_weights(</span>
            <span class="c1">#         weights=self.orchestrator_model.get_weights(),</span>
            <span class="c1">#         gradients = avg_global_gradients,</span>
            <span class="c1">#         learning_rate = learning_rate,</span>
            <span class="c1">#         )</span>
            <span class="c1"># self.orchestrator_model.update_weights(new_global_weights)</span>

            <span class="c1"># # Step VII: Post-training evaluation</span>
            <span class="c1"># # Preserving the orchestrator&#39;s model</span>
            <span class="c1"># self.orchestrator_model.store_model_on_disk(iteration=iteration,</span>
            <span class="c1">#                                             path=orchestrator_models_savepath)</span>
            <span class="c1"># Evaluating the new set of weights on local datasets.</span>
            <span class="n">automatic_node_evaluation</span><span class="p">(</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;after_update_metrics.csv&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># # Evaluating the new set of weights on orchestrator&#39;s dataset.</span>
            <span class="c1"># evaluate_model(</span>
            <span class="c1">#     iteration=iteration,</span>
            <span class="c1">#     model=self.orchestrator_model,</span>
            <span class="c1">#     save_path=os.path.join(metrics_savepath, &quot;orchestrator_metrics.csv&quot;))</span>

        <span class="c1"># Step VIII: Out-of-loop (end of the training)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cluster_structure_savepath</span><span class="p">,</span> <span class="s2">&quot;all_clustering_structures&quot;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">save_nested_dict_ascsv</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s1">&#39;cluster_id_mapping.csv&#39;</span><span class="p">))</span>
        <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Training complete&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>


    <span class="k">def</span> <span class="nf">training_protocol_briggs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">iterations</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">local_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">aggrgator</span><span class="p">:</span> <span class="n">Aggregator</span><span class="p">,</span>
        <span class="n">clustering_round</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">distance_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">metrics_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">nodes_models_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">orchestrator_models_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">sim_matrices_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cluster_structure_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">batch_job</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs a full federated training according to the initialized</span>
<span class="sd">        settings. The train_protocol of the generic_orchestrator.Orchestrator</span>
<span class="sd">        follows a classic FedOpt algorithm - it averages the local gradients </span>
<span class="sd">        and aggregates them using a selecred optimizer.</span>
<span class="sd">        SOURCE: </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        iterations: int</span>
<span class="sd">            Number of (global) iterations // epochs to train the models for.</span>
<span class="sd">        sample_size: int</span>
<span class="sd">            Size of the sample</span>
<span class="sd">        local_epochs: int</span>
<span class="sd">            Number of local epochs for which the local model should</span>
<span class="sd">            be trained.</span>
<span class="sd">        aggregator: Aggregator</span>
<span class="sd">            Instance of the Aggregator object that will be used to aggregate the result each round</span>
<span class="sd">        clustering_round: int</span>
<span class="sd">            Round during which a clustering will occur</span>
<span class="sd">        learning_rate: float</span>
<span class="sd">            Learning rate to be used for optimization.</span>
<span class="sd">        metrics_savepath: str</span>
<span class="sd">            Path for saving the metrics</span>
<span class="sd">        nodes_models_savepath: str</span>
<span class="sd">            Path for saving the models in the .pt format.</span>
<span class="sd">        orchestrator_models_savepath: str</span>
<span class="sd">            Path for saving the orchestrator models.</span>
<span class="sd">        clustering_root_savepath: str</span>
<span class="sd">            Path for saving all the clustering results (general).</span>
<span class="sd">        sim_matrices_savepath: str</span>
<span class="sd">            Path for saving all the similarity matrices.</span>
<span class="sd">        cluster_structure_savepath: str</span>
<span class="sd">            Path for saving all the cluster structures.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Returns 0 on the successful completion of the training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Step I: Create first cluster (the whole population)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">Cluster_Structure</span><span class="p">(</span>
            <span class="n">population</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">]),</span> <span class="c1"># First cluster, all nodes belonging to it.</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()),</span> <span class="c1"># Model for the first cluster, direct copy of the central orchestrator model.</span>
            <span class="n">iteration</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># Created During the First Iteration</span>
        <span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]}</span> <span class="c1"># List of all clusters that were created during the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span> <span class="c1"># mapping between iteration: {node: cluster_id}</span>

        <span class="c1"># Step II: Looping over the iterations</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>            
            <span class="c1"># Sampling nodes</span>
            <span class="n">sampled_nodes</span> <span class="o">=</span> <span class="n">sample_nodes</span><span class="p">(</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                <span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span><span class="p">,</span>
                <span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span>
            <span class="p">)</span>

            <span class="c1"># Step III: Training nodes</span>
            <span class="n">training_results</span><span class="p">,</span> <span class="n">gradients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_epoch</span><span class="p">(</span>
                <span class="n">sampled_nodes</span><span class="o">=</span><span class="n">sampled_nodes</span><span class="p">,</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">local_epochs</span><span class="o">=</span><span class="n">local_epochs</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;gradients&#39;</span><span class="p">,</span>
                <span class="n">save_model</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">nodes_models_savepath</span><span class="p">,</span>
                <span class="n">batch_job</span><span class="o">=</span><span class="n">batch_job</span>
            <span class="p">)</span>
            <span class="c1"># Preserving metrics of the training</span>
            <span class="n">save_nested_dict_ascsv</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">training_results</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s1">&#39;training_metrics.csv&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># Testing nodes on the local dataset before the model update (only sampled nodes).</span>
            <span class="n">automatic_node_evaluation</span><span class="p">(</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">nodes</span><span class="o">=</span><span class="n">sampled_nodes</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;before_update_metrics.csv&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># Evaluating the generalizability of the local model</span>
            <span class="n">automatic_generalizability_evaluation</span><span class="p">(</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                <span class="n">general_model</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="p">),</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;after_update_generalizability.csv&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="n">clustering_round</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">briggs_hierarchical</span><span class="p">(</span>
                    <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                    <span class="n">gradients</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">gradients</span><span class="p">),</span>
                    <span class="n">sim_mat_savepath</span><span class="o">=</span><span class="n">sim_matrices_savepath</span><span class="p">,</span>
                    <span class="n">distance_threshold</span><span class="o">=</span><span class="n">distance_threshold</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">[</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">loop_current_clusters_keys</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="c1"># Copy obj for iterating # Copy obj for iterating</span>
            <span class="c1"># Step IV: In-cluster aggregation</span>
            <span class="k">for</span> <span class="n">cluster_signature</span> <span class="ow">in</span> <span class="n">loop_current_clusters_keys</span><span class="p">:</span>
                <span class="c1"># Collect in-cluster gradients</span>
                <span class="n">in_cluster_gradients</span> <span class="o">=</span> <span class="n">select_gradients</span><span class="p">(</span>
                <span class="n">nodes_id_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>
                <span class="n">gradients</span><span class="o">=</span><span class="n">gradients</span>
                <span class="p">)</span>
                <span class="n">avg_incluster_gradients</span> <span class="o">=</span> <span class="n">average_of_weigts</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">in_cluster_gradients</span><span class="p">))</span>
                <span class="c1"># Updating weights</span>
                <span class="n">new_incluster_weights</span> <span class="o">=</span> <span class="n">aggrgator</span><span class="o">.</span><span class="n">optimize_weights</span><span class="p">(</span>
                    <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                    <span class="n">gradients</span> <span class="o">=</span> <span class="n">avg_incluster_gradients</span><span class="p">,</span>
                    <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="c1"># Update weights of the cluster model</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_incluster_weights</span><span class="p">)</span>
                <span class="c1"># Updating weights for each node in the cluster</span>
                <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">node_id</span> <span class="o">==</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">new_incluster_weights</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_signature</span>

            <span class="c1"># # Step VI: Mixing the global model</span>
            <span class="c1"># avg_global_gradients = average_of_weigts(gradients)</span>
            <span class="c1"># # Updating the weights for the central model</span>
            <span class="c1"># new_global_weights = aggrgator.optimize_weights(</span>
            <span class="c1">#         weights=self.orchestrator_model.get_weights(),</span>
            <span class="c1">#         gradients = avg_global_gradients,</span>
            <span class="c1">#         learning_rate = learning_rate,</span>
            <span class="c1">#         )</span>
            <span class="c1"># self.orchestrator_model.update_weights(new_global_weights)</span>

            <span class="c1"># # Step VII: Post-training evaluation</span>
            <span class="c1"># # Preserving the orchestrator&#39;s model</span>
            <span class="c1"># self.orchestrator_model.store_model_on_disk(iteration=iteration,</span>
            <span class="c1">#                                             path=orchestrator_models_savepath)</span>
            <span class="c1"># Evaluating the new set of weights on local datasets.</span>
            <span class="n">automatic_node_evaluation</span><span class="p">(</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;after_update_metrics.csv&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># # Evaluating the new set of weights on orchestrator&#39;s dataset.</span>
            <span class="c1"># evaluate_model(</span>
            <span class="c1">#     iteration=iteration,</span>
            <span class="c1">#     model=self.orchestrator_model,</span>
            <span class="c1">#     save_path=os.path.join(metrics_savepath, &quot;orchestrator_metrics.csv&quot;))</span>

        <span class="c1"># Step VIII: Out-of-loop (end of the training)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cluster_structure_savepath</span><span class="p">,</span> <span class="s2">&quot;all_clustering_structures&quot;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">save_nested_dict_ascsv</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s1">&#39;cluster_id_mapping.csv&#39;</span><span class="p">))</span>
        <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Training complete&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>


    <span class="k">def</span> <span class="nf">training_protocol_baseline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">iterations</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">local_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">aggrgator</span><span class="p">:</span> <span class="n">Aggregator</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">metrics_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">nodes_models_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">orchestrator_models_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">sim_matrices_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cluster_structure_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">skip_calculation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">batch_job</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs a full federated training according to the initialized</span>
<span class="sd">        settings. The train_protocol of the generic_orchestrator.Orchestrator</span>
<span class="sd">        follows a classic FedOpt algorithm - it averages the local gradients </span>
<span class="sd">        and aggregates them using a selecred optimizer.</span>
<span class="sd">        SOURCE: </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        iterations: int</span>
<span class="sd">            Number of (global) iterations // epochs to train the models for.</span>
<span class="sd">        sample_size: int</span>
<span class="sd">            Size of the sample</span>
<span class="sd">        local_epochs: int</span>
<span class="sd">            Number of local epochs for which the local model should</span>
<span class="sd">            be trained.</span>
<span class="sd">        aggregator: Aggregator</span>
<span class="sd">            Instance of the Aggregator object that will be used to aggregate the result each round</span>
<span class="sd">        learning_rate: float</span>
<span class="sd">            Learning rate to be used for optimization.</span>
<span class="sd">        metrics_savepath: str</span>
<span class="sd">            Path for saving the metrics</span>
<span class="sd">        nodes_models_savepath: str</span>
<span class="sd">            Path for saving the models in the .pt format.</span>
<span class="sd">        orchestrator_models_savepath: str</span>
<span class="sd">            Path for saving the orchestrator models.</span>
<span class="sd">        clustering_root_savepath: str</span>
<span class="sd">            Path for saving all the clustering results (general).</span>
<span class="sd">        sim_matrices_savepath: str</span>
<span class="sd">            Path for saving all the similarity matrices.</span>
<span class="sd">        cluster_structure_savepath: str</span>
<span class="sd">            Path for saving all the cluster structures.</span>
<span class="sd">        skip_calculation: bool = True</span>
<span class="sd">            If set to True, will skip calculation for the cosine distance matrix</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Returns 0 on the successful completion of the training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Step I: Create first cluster (the whole population)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">Cluster_Structure</span><span class="p">(</span>
            <span class="n">population</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">]),</span> <span class="c1"># First cluster, all nodes belonging to it.</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()),</span> <span class="c1"># Model for the first cluster, direct copy of the central orchestrator model.</span>
            <span class="n">iteration</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># Created During the First Iteration</span>
        <span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]}</span> <span class="c1"># List of all clusters that were created during the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span> <span class="c1"># mapping between iteration: {node: cluster_id}</span>

        <span class="c1"># Step II: Looping over the iterations</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>            
            <span class="c1"># Sampling nodes</span>
            <span class="n">sampled_nodes</span> <span class="o">=</span> <span class="n">sample_nodes</span><span class="p">(</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                <span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span><span class="p">,</span>
                <span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span>
            <span class="p">)</span>

            <span class="c1"># Step III: Training nodes</span>
            <span class="n">training_results</span><span class="p">,</span> <span class="n">gradients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_epoch</span><span class="p">(</span>
                <span class="n">sampled_nodes</span><span class="o">=</span><span class="n">sampled_nodes</span><span class="p">,</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">local_epochs</span><span class="o">=</span><span class="n">local_epochs</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;gradients&#39;</span><span class="p">,</span>
                <span class="n">save_model</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">nodes_models_savepath</span><span class="p">,</span>
                <span class="n">batch_job</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="c1"># Preserving metrics of the training</span>
            <span class="n">save_nested_dict_ascsv</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">training_results</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s1">&#39;training_metrics.csv&#39;</span><span class="p">))</span>
            <span class="c1"># Testing nodes on the local dataset before the model update (only sampled nodes).</span>
            <span class="n">automatic_node_evaluation</span><span class="p">(</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">nodes</span><span class="o">=</span><span class="n">sampled_nodes</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;before_update_metrics.csv&quot;</span><span class="p">))</span>
            <span class="c1"># Evaluating the generalizability of the local model</span>
            <span class="n">automatic_generalizability_evaluation</span><span class="p">(</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                <span class="n">general_model</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="p">),</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;after_update_generalizability.csv&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">skip_calculation</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Step IV: Clustering</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">no_clustering</span><span class="p">(</span>
                    <span class="n">iteratio</span> <span class="o">=</span> <span class="n">iteration</span><span class="p">,</span>
                    <span class="n">gradients</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">gradients</span><span class="p">),</span>
                    <span class="n">sim_mat_savepath</span> <span class="o">=</span> <span class="n">sim_matrices_savepath</span><span class="p">,</span>
                    <span class="n">temperature_save_path</span> <span class="o">=</span> <span class="n">metrics_savepath</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">[</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">loop_current_clusters_keys</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="c1"># Copy obj for iterating</span>
            <span class="c1"># Step V: In-cluster aggregation</span>
            <span class="k">for</span> <span class="n">cluster_signature</span> <span class="ow">in</span> <span class="n">loop_current_clusters_keys</span><span class="p">:</span>
                <span class="c1"># Collect in-cluster gradients</span>
                <span class="n">in_cluster_gradients</span> <span class="o">=</span> <span class="n">select_gradients</span><span class="p">(</span>
                <span class="n">nodes_id_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>
                <span class="n">gradients</span><span class="o">=</span><span class="n">gradients</span>
                <span class="p">)</span>
                <span class="n">avg_incluster_gradients</span> <span class="o">=</span> <span class="n">average_of_weigts</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">in_cluster_gradients</span><span class="p">))</span>
                <span class="c1"># Updating weights</span>
                <span class="n">new_incluster_weights</span> <span class="o">=</span> <span class="n">aggrgator</span><span class="o">.</span><span class="n">optimize_weights</span><span class="p">(</span>
                    <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                    <span class="n">gradients</span> <span class="o">=</span> <span class="n">avg_incluster_gradients</span><span class="p">,</span>
                    <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="c1"># Update weights of the cluster model</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_incluster_weights</span><span class="p">)</span>
                <span class="c1"># Updating weights for each node in the cluster</span>
                <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">node_id</span> <span class="o">==</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">new_incluster_weights</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_signature</span>

            <span class="c1"># # Step VI: Mixing the global model</span>
            <span class="c1"># avg_global_gradients = average_of_weigts(gradients)</span>
            <span class="c1"># # Updating the weights for the central model</span>
            <span class="c1"># new_global_weights = aggrgator.optimize_weights(</span>
            <span class="c1">#         weights=self.orchestrator_model.get_weights(),</span>
            <span class="c1">#         gradients = avg_global_gradients,</span>
            <span class="c1">#         learning_rate = learning_rate,</span>
            <span class="c1">#         )</span>
            <span class="c1"># self.orchestrator_model.update_weights(new_global_weights)</span>

            <span class="c1"># # Step VII: Post-training evaluation</span>
            <span class="c1"># # Preserving the orchestrator&#39;s model</span>
            <span class="c1"># self.orchestrator_model.store_model_on_disk(iteration=iteration,</span>
            <span class="c1">#                                             path=orchestrator_models_savepath)</span>
            <span class="c1"># Evaluating the new set of weights on local datasets.</span>
            <span class="n">automatic_node_evaluation</span><span class="p">(</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;after_update_metrics.csv&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># # Evaluating the new set of weights on orchestrator&#39;s dataset.</span>
            <span class="c1"># evaluate_model(</span>
            <span class="c1">#     iteration=iteration,</span>
            <span class="c1">#     model=self.orchestrator_model,</span>
            <span class="c1">#     save_path=os.path.join(metrics_savepath, &quot;orchestrator_metrics.csv&quot;))</span>

        <span class="c1"># Step VIII: Out-of-loop (end of the training)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cluster_structure_savepath</span><span class="p">,</span> <span class="s2">&quot;all_clustering_structures&quot;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">save_nested_dict_ascsv</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s1">&#39;cluster_id_mapping.csv&#39;</span><span class="p">))</span>
        <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Training complete&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>


    <span class="k">def</span> <span class="nf">training_protocol_sattler</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">iterations</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">local_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">aggrgator</span><span class="p">:</span> <span class="n">Aggregator</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">EPS1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">EPS2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">round_cooldown</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">metrics_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">nodes_models_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">orchestrator_models_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">sim_matrices_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cluster_structure_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">batch_job</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs a full federated training according to the initialized</span>
<span class="sd">        settings. The train_protocol of the generic_orchestrator.Orchestrator</span>
<span class="sd">        follows a classic FedOpt algorithm - it averages the local gradients </span>
<span class="sd">        and aggregates them using a selecred optimizer.</span>
<span class="sd">        SOURCE: </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        iterations: int</span>
<span class="sd">            Number of (global) iterations // epochs to train the models for.</span>
<span class="sd">        sample_size: int</span>
<span class="sd">            Size of the sample</span>
<span class="sd">        local_epochs: int</span>
<span class="sd">            Number of local epochs for which the local model should</span>
<span class="sd">            be trained.</span>
<span class="sd">        aggregator: Aggregator</span>
<span class="sd">            Instance of the Aggregator object that will be used to aggregate the result each round</span>
<span class="sd">        learning_rate: float</span>
<span class="sd">            Learning rate to be used for optimization.</span>
<span class="sd">        metrics_savepath: str</span>
<span class="sd">            Path for saving the metrics</span>
<span class="sd">        nodes_models_savepath: str</span>
<span class="sd">            Path for saving the models in the .pt format.</span>
<span class="sd">        orchestrator_models_savepath: str</span>
<span class="sd">            Path for saving the orchestrator models.</span>
<span class="sd">        clustering_root_savepath: str</span>
<span class="sd">            Path for saving all the clustering results (general).</span>
<span class="sd">        sim_matrices_savepath: str</span>
<span class="sd">            Path for saving all the similarity matrices.</span>
<span class="sd">        cluster_structure_savepath: str</span>
<span class="sd">            Path for saving all the cluster structures.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Returns 0 on the successful completion of the training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Step I: Create first cluster (the whole population)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">Cluster_Structure</span><span class="p">(</span>
            <span class="n">population</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">]),</span> <span class="c1"># First cluster, all nodes belonging to it.</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()),</span> <span class="c1"># Model for the first cluster, direct copy of the central orchestrator model.</span>
            <span class="n">iteration</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># Created During the First Iteration</span>
        <span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]}</span> <span class="c1"># List of all clusters that were created during the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span> <span class="c1"># mapping between iteration: {node: cluster_id}</span>

        <span class="c1"># Step II: Looping over the iterations</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>            
            <span class="c1"># Sampling nodes</span>
            <span class="n">sampled_nodes</span> <span class="o">=</span> <span class="n">sample_nodes</span><span class="p">(</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                <span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span><span class="p">,</span>
                <span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span>
            <span class="p">)</span>

            <span class="c1"># Step III: Training nodes</span>
            <span class="n">training_results</span><span class="p">,</span> <span class="n">gradients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_epoch</span><span class="p">(</span>
                <span class="n">sampled_nodes</span><span class="o">=</span><span class="n">sampled_nodes</span><span class="p">,</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">local_epochs</span><span class="o">=</span><span class="n">local_epochs</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;gradients&#39;</span><span class="p">,</span>
                <span class="n">save_model</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">nodes_models_savepath</span><span class="p">,</span>
                <span class="n">batch_job</span><span class="o">=</span><span class="n">batch_job</span>
            <span class="p">)</span>
            <span class="c1"># Preserving metrics of the training</span>
            <span class="n">save_nested_dict_ascsv</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">training_results</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s1">&#39;training_metrics.csv&#39;</span><span class="p">))</span>
            <span class="c1"># Testing nodes on the local dataset before the model update (only sampled nodes).</span>
            <span class="n">automatic_node_evaluation</span><span class="p">(</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">nodes</span><span class="o">=</span><span class="n">sampled_nodes</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;before_update_metrics.csv&quot;</span><span class="p">))</span>
                        <span class="c1"># Evaluating the generalizability of the local model</span>
            <span class="n">automatic_generalizability_evaluation</span><span class="p">(</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                <span class="n">general_model</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="p">),</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;after_update_generalizability.csv&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Clustering</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sattler_clustering</span><span class="p">(</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">gradients</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">gradients</span><span class="p">),</span>
                <span class="n">EPS_1</span><span class="o">=</span><span class="n">EPS1</span><span class="p">,</span>
                <span class="n">EPS_2</span><span class="o">=</span><span class="n">EPS2</span><span class="p">,</span>
                <span class="n">round_cooldown</span><span class="o">=</span><span class="n">round_cooldown</span><span class="p">,</span>
                <span class="n">sim_mat_savepath</span><span class="o">=</span><span class="n">sim_matrices_savepath</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">[</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">loop_current_clusters_keys</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="c1"># Copy obj for iterating # Copy obj for iterating</span>
            <span class="c1"># Step V: In-cluster aggregation</span>
            <span class="k">for</span> <span class="n">cluster_signature</span> <span class="ow">in</span> <span class="n">loop_current_clusters_keys</span><span class="p">:</span>
                <span class="c1"># Collect in-cluster gradients</span>
                <span class="n">in_cluster_gradients</span> <span class="o">=</span> <span class="n">select_gradients</span><span class="p">(</span>
                <span class="n">nodes_id_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>
                <span class="n">gradients</span><span class="o">=</span><span class="n">gradients</span>
                <span class="p">)</span>
                <span class="n">avg_incluster_gradients</span> <span class="o">=</span> <span class="n">average_of_weigts</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">in_cluster_gradients</span><span class="p">))</span>
                <span class="c1"># Updating weights</span>
                <span class="n">new_incluster_weights</span> <span class="o">=</span> <span class="n">aggrgator</span><span class="o">.</span><span class="n">optimize_weights</span><span class="p">(</span>
                    <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                    <span class="n">gradients</span> <span class="o">=</span> <span class="n">avg_incluster_gradients</span><span class="p">,</span>
                    <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Update weights of the cluster model</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_incluster_weights</span><span class="p">)</span>
                <span class="c1"># Updating weights for each node in the cluster</span>
                <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">node_id</span> <span class="o">==</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">new_incluster_weights</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_signature</span>

            <span class="c1"># # Step VI: Mixing the global model</span>
            <span class="c1"># avg_global_gradients = average_of_weigts(gradients)</span>
            <span class="c1"># # Updating the weights for the central model</span>
            <span class="c1"># new_global_weights = aggrgator.optimize_weights(</span>
            <span class="c1">#         weights=self.orchestrator_model.get_weights(),</span>
            <span class="c1">#         gradients = avg_global_gradients,</span>
            <span class="c1">#         learning_rate = learning_rate,</span>
            <span class="c1">#         )</span>
            <span class="c1"># self.orchestrator_model.update_weights(new_global_weights)</span>

            <span class="c1"># # Step VII: Post-training evaluation</span>
            <span class="c1"># # Preserving the orchestrator&#39;s model</span>
            <span class="c1"># self.orchestrator_model.store_model_on_disk(iteration=iteration,</span>
            <span class="c1">#                                             path=orchestrator_models_savepath)</span>
            <span class="c1"># Evaluating the new set of weights on local datasets.</span>
            <span class="n">automatic_node_evaluation</span><span class="p">(</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;after_update_metrics.csv&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># Evaluating the new set of weights on orchestrator&#39;s dataset.</span>
            <span class="c1"># evaluate_model(</span>
            <span class="c1">#     iteration=iteration,</span>
            <span class="c1">#     model=self.orchestrator_model,</span>
            <span class="c1">#     save_path=os.path.join(metrics_savepath, &quot;orchestrator_metrics.csv&quot;))</span>

        <span class="c1"># Step VIII: Out-of-loop (end of the training)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cluster_structure_savepath</span><span class="p">,</span> <span class="s2">&quot;all_clustering_structures&quot;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">save_nested_dict_ascsv</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s1">&#39;cluster_id_mapping.csv&#39;</span><span class="p">))</span>
        <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Training complete&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="simulation.simulation.Simulation.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_template</span><span class="p">,</span> <span class="n">node_template</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Creating simulation instant requires providing an already created instance of model template
and node template. Those instances then will be copied n-times to create n different nodes, each
with a different dataset. Additionally, a data for local nodes should be passed in form of a dictionary,
maping dataset to each respective client.</p>
<h5 id="simulation.simulation.Simulation.__init__--parameters">Parameters</h5>
<p>model_template : FederatedModel
    Initialized instance of a Federated Model class that will be uploaded to every client.
node_template : FederatedNode
    Initialized instance of a Federated Node class that will be used to simulate nodes.
seed : int,
    Seed for the simulation, default to 42
<strong>kwargs : dict, optional
    Extra arguments to enable selected features of the Orchestrator.
    passing full_debug to </strong>kwargs, allow to enter a full debug mode.</p>
<h5 id="simulation.simulation.Simulation.__init__--returns">Returns</h5>
<p>None</p>

            <details class="quote">
              <summary>Source code in <code>EFL\simulation\simulation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> 
    <span class="n">model_template</span><span class="p">:</span> <span class="n">FederatedModel</span><span class="p">,</span>
    <span class="n">node_template</span><span class="p">:</span> <span class="n">FederatedNode</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creating simulation instant requires providing an already created instance of model template</span>
<span class="sd">    and node template. Those instances then will be copied n-times to create n different nodes, each</span>
<span class="sd">    with a different dataset. Additionally, a data for local nodes should be passed in form of a dictionary,</span>
<span class="sd">    maping dataset to each respective client.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_template : FederatedModel</span>
<span class="sd">        Initialized instance of a Federated Model class that will be uploaded to every client.</span>
<span class="sd">    node_template : FederatedNode</span>
<span class="sd">        Initialized instance of a Federated Node class that will be used to simulate nodes.</span>
<span class="sd">    seed : int,</span>
<span class="sd">        Seed for the simulation, default to 42</span>
<span class="sd">    **kwargs : dict, optional</span>
<span class="sd">        Extra arguments to enable selected features of the Orchestrator.</span>
<span class="sd">        passing full_debug to **kwargs, allow to enter a full debug mode.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_template</span> <span class="o">=</span> <span class="n">model_template</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">node_template</span> <span class="o">=</span> <span class="n">node_template</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">flattened_model_length</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">clusters_namespace</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="simulation.simulation.Simulation.attach_node_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">attach_node_model</span><span class="p">(</span><span class="n">nodes_data</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Attaches models of the nodes to the simulation instance.</p>
<h5 id="simulation.simulation.Simulation.attach_node_model--parameters">Parameters</h5>
<p>orchestrator_data: Any
    Orchestrator data that should be attached to nodes models.
Returns</p>
<hr />
<p>None</p>

            <details class="quote">
              <summary>Source code in <code>EFL\simulation\simulation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">attach_node_model</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">nodes_data</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Attaches models of the nodes to the simulation instance.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    orchestrator_data: Any</span>
<span class="sd">        Orchestrator data that should be attached to nodes models.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">nodes_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_template</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span><span class="o">.</span><span class="n">connect_data_id</span><span class="p">(</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">node_id</span><span class="p">,</span>
                                              <span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_template</span><span class="p">),</span>
                                              <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># Calculting the length of the model -&gt; for creating similarity matrix</span>
    <span class="n">flattened_model</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">))]</span><span class="o">.</span><span class="n">model</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">flattened_model</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> 
    <span class="bp">self</span><span class="o">.</span><span class="n">flattened_model_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flattened_model</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="simulation.simulation.Simulation.attach_orchestrator_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">attach_orchestrator_model</span><span class="p">(</span><span class="n">orchestrator_data</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Attaches model of the orchestrator that is saved as an instance attribute.</p>
<h5 id="simulation.simulation.Simulation.attach_orchestrator_model--parameters">Parameters</h5>
<p>orchestrator_data: Any 
    Orchestrator data that should be attached to the orchestrator model.</p>
<h5 id="simulation.simulation.Simulation.attach_orchestrator_model--returns">Returns</h5>
<p>None</p>

            <details class="quote">
              <summary>Source code in <code>EFL\simulation\simulation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">attach_orchestrator_model</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">orchestrator_data</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Attaches model of the orchestrator that is saved as an instance attribute.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    orchestrator_data: Any </span>
<span class="sd">        Orchestrator data that should be attached to the orchestrator model.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_template</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="o">.</span><span class="n">attach_dataset_id</span><span class="p">(</span><span class="n">local_dataset</span><span class="o">=</span><span class="p">[</span><span class="n">orchestrator_data</span><span class="p">],</span>
                                              <span class="n">node_name</span><span class="o">=</span><span class="s1">&#39;orchestrator&#39;</span><span class="p">,</span>
                                              <span class="n">only_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="simulation.simulation.Simulation.train_epoch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train_epoch</span><span class="p">(</span><span class="n">sampled_nodes</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">local_epochs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;weights&#39;</span><span class="p">,</span> <span class="n">save_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_job</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Performs one training round of a federated learning. Returns training
results upon completion.</p>
<h5 id="simulation.simulation.Simulation.train_epoch--parameters">Parameters</h5>
<p>samples_nodes: dict[int: FederatedNode]
    Dictionary containing sampled Federated Nodes
iteration: int
    Current global iteration of the training process
local_epochs: int
    Number of local epochs for which the local model should
    be trained.
mode: str (default to 'weights')
    Mode = 'weights': Node will return model's weights.
    Mode = 'gradients': Node will return model's gradients.
save_model: bool (default to False)
    Boolean flag to save a model.
save_path: str (defualt to None)
    Path object used to save a model</p>
<h5 id="simulation.simulation.Simulation.train_epoch--returns">Returns</h5>
<p>tuple[dict[int, int, float, float, list, list], dict[int, OrderedDict]]</p>

            <details class="quote">
              <summary>Source code in <code>EFL\simulation\simulation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train_epoch</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">sampled_nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">:</span> <span class="n">FederatedNode</span><span class="p">],</span>
    <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">local_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span>
    <span class="n">save_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_job</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Performs one training round of a federated learning. Returns training</span>
<span class="sd">    results upon completion.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    samples_nodes: dict[int: FederatedNode]</span>
<span class="sd">        Dictionary containing sampled Federated Nodes</span>
<span class="sd">    iteration: int</span>
<span class="sd">        Current global iteration of the training process</span>
<span class="sd">    local_epochs: int</span>
<span class="sd">        Number of local epochs for which the local model should</span>
<span class="sd">        be trained.</span>
<span class="sd">    mode: str (default to &#39;weights&#39;)</span>
<span class="sd">        Mode = &#39;weights&#39;: Node will return model&#39;s weights.</span>
<span class="sd">        Mode = &#39;gradients&#39;: Node will return model&#39;s gradients.</span>
<span class="sd">    save_model: bool (default to False)</span>
<span class="sd">        Boolean flag to save a model.</span>
<span class="sd">    save_path: str (defualt to None)</span>
<span class="sd">        Path object used to save a model</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[dict[int, int, float, float, list, list], dict[int, OrderedDict]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">training_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">batch_job</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">chunker_dict</span><span class="p">(</span><span class="n">sampled_nodes</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">))</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">train_nodes</span><span class="p">,</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">local_epochs</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">save_model</span><span class="p">,</span> <span class="n">save_path</span><span class="p">))</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="n">node_id</span><span class="p">,</span> <span class="n">model_weights</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">,</span> <span class="n">accuracy_list</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="n">weights</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_weights</span>
                    <span class="n">training_results</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">iteration</span><span class="p">,</span>
                        <span class="s2">&quot;node_id&quot;</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span>
                        <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> 
                        <span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="n">accuracy_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s2">&quot;full_loss&quot;</span><span class="p">:</span> <span class="n">loss_list</span><span class="p">,</span>
                        <span class="s2">&quot;full_accuracy&quot;</span><span class="p">:</span> <span class="n">accuracy_list</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sampled_nodes</span><span class="p">))</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">train_nodes</span><span class="p">,</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">local_epochs</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">save_model</span><span class="p">,</span> <span class="n">save_path</span><span class="p">))</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sampled_nodes</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">node_id</span><span class="p">,</span> <span class="n">model_weights</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">,</span> <span class="n">accuracy_list</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">weights</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_weights</span>
                <span class="n">training_results</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">iteration</span><span class="p">,</span>
                    <span class="s2">&quot;node_id&quot;</span><span class="p">:</span> <span class="n">node_id</span><span class="p">,</span>
                    <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> 
                    <span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="n">accuracy_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s2">&quot;full_loss&quot;</span><span class="p">:</span> <span class="n">loss_list</span><span class="p">,</span>
                    <span class="s2">&quot;full_accuracy&quot;</span><span class="p">:</span> <span class="n">accuracy_list</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">training_results</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="simulation.simulation.Simulation.training_protocol_baseline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">training_protocol_baseline</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">local_epochs</span><span class="p">,</span> <span class="n">aggrgator</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">,</span> <span class="n">metrics_savepath</span><span class="p">,</span> <span class="n">nodes_models_savepath</span><span class="p">,</span> <span class="n">orchestrator_models_savepath</span><span class="p">,</span> <span class="n">sim_matrices_savepath</span><span class="p">,</span> <span class="n">cluster_structure_savepath</span><span class="p">,</span> <span class="n">skip_calculation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_job</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Performs a full federated training according to the initialized
settings. The train_protocol of the generic_orchestrator.Orchestrator
follows a classic FedOpt algorithm - it averages the local gradients 
and aggregates them using a selecred optimizer.
SOURCE: </p>
<h5 id="simulation.simulation.Simulation.training_protocol_baseline--parameters">Parameters</h5>
<p>iterations: int
    Number of (global) iterations // epochs to train the models for.
sample_size: int
    Size of the sample
local_epochs: int
    Number of local epochs for which the local model should
    be trained.
aggregator: Aggregator
    Instance of the Aggregator object that will be used to aggregate the result each round
learning_rate: float
    Learning rate to be used for optimization.
metrics_savepath: str
    Path for saving the metrics
nodes_models_savepath: str
    Path for saving the models in the .pt format.
orchestrator_models_savepath: str
    Path for saving the orchestrator models.
clustering_root_savepath: str
    Path for saving all the clustering results (general).
sim_matrices_savepath: str
    Path for saving all the similarity matrices.
cluster_structure_savepath: str
    Path for saving all the cluster structures.
skip_calculation: bool = True
    If set to True, will skip calculation for the cosine distance matrix
Returns</p>
<hr />
<p>int
    Returns 0 on the successful completion of the training.</p>

            <details class="quote">
              <summary>Source code in <code>EFL\simulation\simulation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">training_protocol_baseline</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">iterations</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">local_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">aggrgator</span><span class="p">:</span> <span class="n">Aggregator</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">metrics_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">nodes_models_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">orchestrator_models_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">sim_matrices_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">cluster_structure_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">skip_calculation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">batch_job</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Performs a full federated training according to the initialized</span>
<span class="sd">    settings. The train_protocol of the generic_orchestrator.Orchestrator</span>
<span class="sd">    follows a classic FedOpt algorithm - it averages the local gradients </span>
<span class="sd">    and aggregates them using a selecred optimizer.</span>
<span class="sd">    SOURCE: </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    iterations: int</span>
<span class="sd">        Number of (global) iterations // epochs to train the models for.</span>
<span class="sd">    sample_size: int</span>
<span class="sd">        Size of the sample</span>
<span class="sd">    local_epochs: int</span>
<span class="sd">        Number of local epochs for which the local model should</span>
<span class="sd">        be trained.</span>
<span class="sd">    aggregator: Aggregator</span>
<span class="sd">        Instance of the Aggregator object that will be used to aggregate the result each round</span>
<span class="sd">    learning_rate: float</span>
<span class="sd">        Learning rate to be used for optimization.</span>
<span class="sd">    metrics_savepath: str</span>
<span class="sd">        Path for saving the metrics</span>
<span class="sd">    nodes_models_savepath: str</span>
<span class="sd">        Path for saving the models in the .pt format.</span>
<span class="sd">    orchestrator_models_savepath: str</span>
<span class="sd">        Path for saving the orchestrator models.</span>
<span class="sd">    clustering_root_savepath: str</span>
<span class="sd">        Path for saving all the clustering results (general).</span>
<span class="sd">    sim_matrices_savepath: str</span>
<span class="sd">        Path for saving all the similarity matrices.</span>
<span class="sd">    cluster_structure_savepath: str</span>
<span class="sd">        Path for saving all the cluster structures.</span>
<span class="sd">    skip_calculation: bool = True</span>
<span class="sd">        If set to True, will skip calculation for the cosine distance matrix</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Returns 0 on the successful completion of the training.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Step I: Create first cluster (the whole population)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">Cluster_Structure</span><span class="p">(</span>
        <span class="n">population</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">]),</span> <span class="c1"># First cluster, all nodes belonging to it.</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()),</span> <span class="c1"># Model for the first cluster, direct copy of the central orchestrator model.</span>
        <span class="n">iteration</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># Created During the First Iteration</span>
    <span class="p">)}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]}</span> <span class="c1"># List of all clusters that were created during the simulation</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span> <span class="c1"># mapping between iteration: {node: cluster_id}</span>

    <span class="c1"># Step II: Looping over the iterations</span>
    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
        <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>            
        <span class="c1"># Sampling nodes</span>
        <span class="n">sampled_nodes</span> <span class="o">=</span> <span class="n">sample_nodes</span><span class="p">(</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
            <span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span><span class="p">,</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span>
        <span class="p">)</span>

        <span class="c1"># Step III: Training nodes</span>
        <span class="n">training_results</span><span class="p">,</span> <span class="n">gradients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_epoch</span><span class="p">(</span>
            <span class="n">sampled_nodes</span><span class="o">=</span><span class="n">sampled_nodes</span><span class="p">,</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">local_epochs</span><span class="o">=</span><span class="n">local_epochs</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;gradients&#39;</span><span class="p">,</span>
            <span class="n">save_model</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">nodes_models_savepath</span><span class="p">,</span>
            <span class="n">batch_job</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="c1"># Preserving metrics of the training</span>
        <span class="n">save_nested_dict_ascsv</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">training_results</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s1">&#39;training_metrics.csv&#39;</span><span class="p">))</span>
        <span class="c1"># Testing nodes on the local dataset before the model update (only sampled nodes).</span>
        <span class="n">automatic_node_evaluation</span><span class="p">(</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">nodes</span><span class="o">=</span><span class="n">sampled_nodes</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;before_update_metrics.csv&quot;</span><span class="p">))</span>
        <span class="c1"># Evaluating the generalizability of the local model</span>
        <span class="n">automatic_generalizability_evaluation</span><span class="p">(</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
            <span class="n">general_model</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="p">),</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;after_update_generalizability.csv&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">skip_calculation</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Step IV: Clustering</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_clustering</span><span class="p">(</span>
                <span class="n">iteratio</span> <span class="o">=</span> <span class="n">iteration</span><span class="p">,</span>
                <span class="n">gradients</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">gradients</span><span class="p">),</span>
                <span class="n">sim_mat_savepath</span> <span class="o">=</span> <span class="n">sim_matrices_savepath</span><span class="p">,</span>
                <span class="n">temperature_save_path</span> <span class="o">=</span> <span class="n">metrics_savepath</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">[</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">loop_current_clusters_keys</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="c1"># Copy obj for iterating</span>
        <span class="c1"># Step V: In-cluster aggregation</span>
        <span class="k">for</span> <span class="n">cluster_signature</span> <span class="ow">in</span> <span class="n">loop_current_clusters_keys</span><span class="p">:</span>
            <span class="c1"># Collect in-cluster gradients</span>
            <span class="n">in_cluster_gradients</span> <span class="o">=</span> <span class="n">select_gradients</span><span class="p">(</span>
            <span class="n">nodes_id_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>
            <span class="n">gradients</span><span class="o">=</span><span class="n">gradients</span>
            <span class="p">)</span>
            <span class="n">avg_incluster_gradients</span> <span class="o">=</span> <span class="n">average_of_weigts</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">in_cluster_gradients</span><span class="p">))</span>
            <span class="c1"># Updating weights</span>
            <span class="n">new_incluster_weights</span> <span class="o">=</span> <span class="n">aggrgator</span><span class="o">.</span><span class="n">optimize_weights</span><span class="p">(</span>
                <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">gradients</span> <span class="o">=</span> <span class="n">avg_incluster_gradients</span><span class="p">,</span>
                <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># Update weights of the cluster model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_incluster_weights</span><span class="p">)</span>
            <span class="c1"># Updating weights for each node in the cluster</span>
            <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">node_id</span> <span class="o">==</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">new_incluster_weights</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_signature</span>

        <span class="c1"># # Step VI: Mixing the global model</span>
        <span class="c1"># avg_global_gradients = average_of_weigts(gradients)</span>
        <span class="c1"># # Updating the weights for the central model</span>
        <span class="c1"># new_global_weights = aggrgator.optimize_weights(</span>
        <span class="c1">#         weights=self.orchestrator_model.get_weights(),</span>
        <span class="c1">#         gradients = avg_global_gradients,</span>
        <span class="c1">#         learning_rate = learning_rate,</span>
        <span class="c1">#         )</span>
        <span class="c1"># self.orchestrator_model.update_weights(new_global_weights)</span>

        <span class="c1"># # Step VII: Post-training evaluation</span>
        <span class="c1"># # Preserving the orchestrator&#39;s model</span>
        <span class="c1"># self.orchestrator_model.store_model_on_disk(iteration=iteration,</span>
        <span class="c1">#                                             path=orchestrator_models_savepath)</span>
        <span class="c1"># Evaluating the new set of weights on local datasets.</span>
        <span class="n">automatic_node_evaluation</span><span class="p">(</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;after_update_metrics.csv&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># # Evaluating the new set of weights on orchestrator&#39;s dataset.</span>
        <span class="c1"># evaluate_model(</span>
        <span class="c1">#     iteration=iteration,</span>
        <span class="c1">#     model=self.orchestrator_model,</span>
        <span class="c1">#     save_path=os.path.join(metrics_savepath, &quot;orchestrator_metrics.csv&quot;))</span>

    <span class="c1"># Step VIII: Out-of-loop (end of the training)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cluster_structure_savepath</span><span class="p">,</span> <span class="s2">&quot;all_clustering_structures&quot;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">save_nested_dict_ascsv</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s1">&#39;cluster_id_mapping.csv&#39;</span><span class="p">))</span>
    <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Training complete&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="simulation.simulation.Simulation.training_protocol_briggs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">training_protocol_briggs</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">local_epochs</span><span class="p">,</span> <span class="n">aggrgator</span><span class="p">,</span> <span class="n">clustering_round</span><span class="p">,</span> <span class="n">distance_threshold</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">,</span> <span class="n">metrics_savepath</span><span class="p">,</span> <span class="n">nodes_models_savepath</span><span class="p">,</span> <span class="n">orchestrator_models_savepath</span><span class="p">,</span> <span class="n">sim_matrices_savepath</span><span class="p">,</span> <span class="n">cluster_structure_savepath</span><span class="p">,</span> <span class="n">batch_job</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Performs a full federated training according to the initialized
settings. The train_protocol of the generic_orchestrator.Orchestrator
follows a classic FedOpt algorithm - it averages the local gradients 
and aggregates them using a selecred optimizer.
SOURCE: </p>
<h5 id="simulation.simulation.Simulation.training_protocol_briggs--parameters">Parameters</h5>
<p>iterations: int
    Number of (global) iterations // epochs to train the models for.
sample_size: int
    Size of the sample
local_epochs: int
    Number of local epochs for which the local model should
    be trained.
aggregator: Aggregator
    Instance of the Aggregator object that will be used to aggregate the result each round
clustering_round: int
    Round during which a clustering will occur
learning_rate: float
    Learning rate to be used for optimization.
metrics_savepath: str
    Path for saving the metrics
nodes_models_savepath: str
    Path for saving the models in the .pt format.
orchestrator_models_savepath: str
    Path for saving the orchestrator models.
clustering_root_savepath: str
    Path for saving all the clustering results (general).
sim_matrices_savepath: str
    Path for saving all the similarity matrices.
cluster_structure_savepath: str
    Path for saving all the cluster structures.
Returns</p>
<hr />
<p>int
    Returns 0 on the successful completion of the training.</p>

            <details class="quote">
              <summary>Source code in <code>EFL\simulation\simulation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">training_protocol_briggs</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">iterations</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">local_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">aggrgator</span><span class="p">:</span> <span class="n">Aggregator</span><span class="p">,</span>
    <span class="n">clustering_round</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">distance_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">metrics_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">nodes_models_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">orchestrator_models_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">sim_matrices_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">cluster_structure_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">batch_job</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Performs a full federated training according to the initialized</span>
<span class="sd">    settings. The train_protocol of the generic_orchestrator.Orchestrator</span>
<span class="sd">    follows a classic FedOpt algorithm - it averages the local gradients </span>
<span class="sd">    and aggregates them using a selecred optimizer.</span>
<span class="sd">    SOURCE: </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    iterations: int</span>
<span class="sd">        Number of (global) iterations // epochs to train the models for.</span>
<span class="sd">    sample_size: int</span>
<span class="sd">        Size of the sample</span>
<span class="sd">    local_epochs: int</span>
<span class="sd">        Number of local epochs for which the local model should</span>
<span class="sd">        be trained.</span>
<span class="sd">    aggregator: Aggregator</span>
<span class="sd">        Instance of the Aggregator object that will be used to aggregate the result each round</span>
<span class="sd">    clustering_round: int</span>
<span class="sd">        Round during which a clustering will occur</span>
<span class="sd">    learning_rate: float</span>
<span class="sd">        Learning rate to be used for optimization.</span>
<span class="sd">    metrics_savepath: str</span>
<span class="sd">        Path for saving the metrics</span>
<span class="sd">    nodes_models_savepath: str</span>
<span class="sd">        Path for saving the models in the .pt format.</span>
<span class="sd">    orchestrator_models_savepath: str</span>
<span class="sd">        Path for saving the orchestrator models.</span>
<span class="sd">    clustering_root_savepath: str</span>
<span class="sd">        Path for saving all the clustering results (general).</span>
<span class="sd">    sim_matrices_savepath: str</span>
<span class="sd">        Path for saving all the similarity matrices.</span>
<span class="sd">    cluster_structure_savepath: str</span>
<span class="sd">        Path for saving all the cluster structures.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Returns 0 on the successful completion of the training.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Step I: Create first cluster (the whole population)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">Cluster_Structure</span><span class="p">(</span>
        <span class="n">population</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">]),</span> <span class="c1"># First cluster, all nodes belonging to it.</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()),</span> <span class="c1"># Model for the first cluster, direct copy of the central orchestrator model.</span>
        <span class="n">iteration</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># Created During the First Iteration</span>
    <span class="p">)}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]}</span> <span class="c1"># List of all clusters that were created during the simulation</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span> <span class="c1"># mapping between iteration: {node: cluster_id}</span>

    <span class="c1"># Step II: Looping over the iterations</span>
    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
        <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>            
        <span class="c1"># Sampling nodes</span>
        <span class="n">sampled_nodes</span> <span class="o">=</span> <span class="n">sample_nodes</span><span class="p">(</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
            <span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span><span class="p">,</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span>
        <span class="p">)</span>

        <span class="c1"># Step III: Training nodes</span>
        <span class="n">training_results</span><span class="p">,</span> <span class="n">gradients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_epoch</span><span class="p">(</span>
            <span class="n">sampled_nodes</span><span class="o">=</span><span class="n">sampled_nodes</span><span class="p">,</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">local_epochs</span><span class="o">=</span><span class="n">local_epochs</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;gradients&#39;</span><span class="p">,</span>
            <span class="n">save_model</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">nodes_models_savepath</span><span class="p">,</span>
            <span class="n">batch_job</span><span class="o">=</span><span class="n">batch_job</span>
        <span class="p">)</span>
        <span class="c1"># Preserving metrics of the training</span>
        <span class="n">save_nested_dict_ascsv</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">training_results</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s1">&#39;training_metrics.csv&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Testing nodes on the local dataset before the model update (only sampled nodes).</span>
        <span class="n">automatic_node_evaluation</span><span class="p">(</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">nodes</span><span class="o">=</span><span class="n">sampled_nodes</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;before_update_metrics.csv&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Evaluating the generalizability of the local model</span>
        <span class="n">automatic_generalizability_evaluation</span><span class="p">(</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
            <span class="n">general_model</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="p">),</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;after_update_generalizability.csv&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="n">clustering_round</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">briggs_hierarchical</span><span class="p">(</span>
                <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
                <span class="n">gradients</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">gradients</span><span class="p">),</span>
                <span class="n">sim_mat_savepath</span><span class="o">=</span><span class="n">sim_matrices_savepath</span><span class="p">,</span>
                <span class="n">distance_threshold</span><span class="o">=</span><span class="n">distance_threshold</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">[</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">loop_current_clusters_keys</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="c1"># Copy obj for iterating # Copy obj for iterating</span>
        <span class="c1"># Step IV: In-cluster aggregation</span>
        <span class="k">for</span> <span class="n">cluster_signature</span> <span class="ow">in</span> <span class="n">loop_current_clusters_keys</span><span class="p">:</span>
            <span class="c1"># Collect in-cluster gradients</span>
            <span class="n">in_cluster_gradients</span> <span class="o">=</span> <span class="n">select_gradients</span><span class="p">(</span>
            <span class="n">nodes_id_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>
            <span class="n">gradients</span><span class="o">=</span><span class="n">gradients</span>
            <span class="p">)</span>
            <span class="n">avg_incluster_gradients</span> <span class="o">=</span> <span class="n">average_of_weigts</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">in_cluster_gradients</span><span class="p">))</span>
            <span class="c1"># Updating weights</span>
            <span class="n">new_incluster_weights</span> <span class="o">=</span> <span class="n">aggrgator</span><span class="o">.</span><span class="n">optimize_weights</span><span class="p">(</span>
                <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">gradients</span> <span class="o">=</span> <span class="n">avg_incluster_gradients</span><span class="p">,</span>
                <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># Update weights of the cluster model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_incluster_weights</span><span class="p">)</span>
            <span class="c1"># Updating weights for each node in the cluster</span>
            <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">node_id</span> <span class="o">==</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">new_incluster_weights</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_signature</span>

        <span class="c1"># # Step VI: Mixing the global model</span>
        <span class="c1"># avg_global_gradients = average_of_weigts(gradients)</span>
        <span class="c1"># # Updating the weights for the central model</span>
        <span class="c1"># new_global_weights = aggrgator.optimize_weights(</span>
        <span class="c1">#         weights=self.orchestrator_model.get_weights(),</span>
        <span class="c1">#         gradients = avg_global_gradients,</span>
        <span class="c1">#         learning_rate = learning_rate,</span>
        <span class="c1">#         )</span>
        <span class="c1"># self.orchestrator_model.update_weights(new_global_weights)</span>

        <span class="c1"># # Step VII: Post-training evaluation</span>
        <span class="c1"># # Preserving the orchestrator&#39;s model</span>
        <span class="c1"># self.orchestrator_model.store_model_on_disk(iteration=iteration,</span>
        <span class="c1">#                                             path=orchestrator_models_savepath)</span>
        <span class="c1"># Evaluating the new set of weights on local datasets.</span>
        <span class="n">automatic_node_evaluation</span><span class="p">(</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;after_update_metrics.csv&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># # Evaluating the new set of weights on orchestrator&#39;s dataset.</span>
        <span class="c1"># evaluate_model(</span>
        <span class="c1">#     iteration=iteration,</span>
        <span class="c1">#     model=self.orchestrator_model,</span>
        <span class="c1">#     save_path=os.path.join(metrics_savepath, &quot;orchestrator_metrics.csv&quot;))</span>

    <span class="c1"># Step VIII: Out-of-loop (end of the training)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cluster_structure_savepath</span><span class="p">,</span> <span class="s2">&quot;all_clustering_structures&quot;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">save_nested_dict_ascsv</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s1">&#39;cluster_id_mapping.csv&#39;</span><span class="p">))</span>
    <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Training complete&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="simulation.simulation.Simulation.training_protocol_energy_oneshot" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">training_protocol_energy_oneshot</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">local_epochs</span><span class="p">,</span> <span class="n">aggrgator</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">,</span> <span class="n">clustering_algorithm</span><span class="p">,</span> <span class="n">metrics_savepath</span><span class="p">,</span> <span class="n">nodes_models_savepath</span><span class="p">,</span> <span class="n">orchestrator_models_savepath</span><span class="p">,</span> <span class="n">sim_matrices_savepath</span><span class="p">,</span> <span class="n">cluster_structure_savepath</span><span class="p">,</span> <span class="n">skip_calculation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_job</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Performs a full federated training according to the initialized
settings. The train_protocol of the generic_orchestrator.Orchestrator
follows a classic FedOpt algorithm - it averages the local gradients 
and aggregates them using a selected optimizer.
SOURCE: </p>
<h5 id="simulation.simulation.Simulation.training_protocol_energy_oneshot--parameters">Parameters</h5>
<p>iterations: int
    Number of (global) iterations // epochs to train the models for.
sample_size: int
    Size of the sample
local_epochs: int
    Number of local epochs for which the local model should
    be trained.
aggregator: Aggregator
    Instance of the Aggregator object that will be used to aggregate the result each round
learning_rate: float
    Learning rate to be used for optimization.
metrics_savepath: str
    Path for saving the metrics
nodes_models_savepath: str
    Path for saving the models in the .pt format.
orchestrator_models_savepath: str
    Path for saving the orchestrator models.
clustering_root_savepath: str
    Path for saving all the clustering results (general).
sim_matrices_savepath: str
    Path for saving all the similarity matrices.
cluster_structure_savepath: str
    Path for saving all the cluster structures.
skip_calculation: bool
    If set to True, will caculate Cosine Distance / Similarity values only when clustering.
Returns</p>
<hr />
<p>int
    Returns 0 on the successful completion of the training.</p>

            <details class="quote">
              <summary>Source code in <code>EFL\simulation\simulation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">training_protocol_energy_oneshot</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">iterations</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">local_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">aggrgator</span><span class="p">:</span> <span class="n">Aggregator</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">clustering_algorithm</span><span class="p">:</span> <span class="n">cluster</span><span class="p">,</span>
    <span class="n">metrics_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">nodes_models_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">orchestrator_models_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">sim_matrices_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">cluster_structure_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">skip_calculation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">batch_job</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Performs a full federated training according to the initialized</span>
<span class="sd">    settings. The train_protocol of the generic_orchestrator.Orchestrator</span>
<span class="sd">    follows a classic FedOpt algorithm - it averages the local gradients </span>
<span class="sd">    and aggregates them using a selected optimizer.</span>
<span class="sd">    SOURCE: </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    iterations: int</span>
<span class="sd">        Number of (global) iterations // epochs to train the models for.</span>
<span class="sd">    sample_size: int</span>
<span class="sd">        Size of the sample</span>
<span class="sd">    local_epochs: int</span>
<span class="sd">        Number of local epochs for which the local model should</span>
<span class="sd">        be trained.</span>
<span class="sd">    aggregator: Aggregator</span>
<span class="sd">        Instance of the Aggregator object that will be used to aggregate the result each round</span>
<span class="sd">    learning_rate: float</span>
<span class="sd">        Learning rate to be used for optimization.</span>
<span class="sd">    metrics_savepath: str</span>
<span class="sd">        Path for saving the metrics</span>
<span class="sd">    nodes_models_savepath: str</span>
<span class="sd">        Path for saving the models in the .pt format.</span>
<span class="sd">    orchestrator_models_savepath: str</span>
<span class="sd">        Path for saving the orchestrator models.</span>
<span class="sd">    clustering_root_savepath: str</span>
<span class="sd">        Path for saving all the clustering results (general).</span>
<span class="sd">    sim_matrices_savepath: str</span>
<span class="sd">        Path for saving all the similarity matrices.</span>
<span class="sd">    cluster_structure_savepath: str</span>
<span class="sd">        Path for saving all the cluster structures.</span>
<span class="sd">    skip_calculation: bool</span>
<span class="sd">        If set to True, will caculate Cosine Distance / Similarity values only when clustering.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Returns 0 on the successful completion of the training.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Step I: Create first cluster (the whole population)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">Cluster_Structure</span><span class="p">(</span>
        <span class="n">population</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">]),</span> <span class="c1"># First cluster, all nodes belonging to it.</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()),</span> <span class="c1"># Model for the first cluster, direct copy of the central orchestrator model.</span>
        <span class="n">iteration</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># Created During the First Iteration</span>
    <span class="p">)}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]}</span> <span class="c1"># List of all clusters that were created during the simulation</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span> <span class="c1"># mapping between iteration: {node: cluster_id}</span>

    <span class="c1"># Step II: Setting the &#39;clustering shot&#39; flag to False</span>
    <span class="n">clustering_shot</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">last_temperature</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

    <span class="c1"># Step III: Looping over the iterations</span>
    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
        <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>            
        <span class="c1"># Sampling nodes</span>
        <span class="n">sampled_nodes</span> <span class="o">=</span> <span class="n">sample_nodes</span><span class="p">(</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
            <span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span><span class="p">,</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span>
        <span class="p">)</span>

        <span class="c1"># Step IV: Training nodes</span>
        <span class="n">training_results</span><span class="p">,</span> <span class="n">gradients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_epoch</span><span class="p">(</span>
            <span class="n">sampled_nodes</span><span class="o">=</span><span class="n">sampled_nodes</span><span class="p">,</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">local_epochs</span><span class="o">=</span><span class="n">local_epochs</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;gradients&#39;</span><span class="p">,</span>
            <span class="n">save_model</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">nodes_models_savepath</span><span class="p">,</span>
            <span class="n">batch_job</span><span class="o">=</span><span class="n">batch_job</span>
        <span class="p">)</span>
        <span class="c1"># Preserving metrics of the training</span>
        <span class="n">save_nested_dict_ascsv</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">training_results</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s1">&#39;training_metrics.csv&#39;</span><span class="p">))</span>
        <span class="c1"># Testing nodes on the local dataset before the model update (only sampled nodes).</span>
        <span class="n">automatic_node_evaluation</span><span class="p">(</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">nodes</span><span class="o">=</span><span class="n">sampled_nodes</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;before_update_metrics.csv&quot;</span><span class="p">))</span>
                    <span class="c1"># Evaluating the generalizability of the local model</span>
        <span class="n">automatic_generalizability_evaluation</span><span class="p">(</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
            <span class="n">general_model</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="p">),</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;after_update_generalizability.csv&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># If clustering was performed before and we want to skip saving cosdist mat</span>
        <span class="k">if</span> <span class="n">clustering_shot</span> <span class="ow">and</span> <span class="n">skip_calculation</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># Do not change the self.current_clusters architecture</span>
        <span class="c1"># Else perform a full procedure</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Clustering</span>
            <span class="n">clustering_shot</span><span class="p">,</span> <span class="n">last_temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_oneshot</span><span class="p">(</span>
                <span class="n">clustering_algorithm</span> <span class="o">=</span> <span class="n">clustering_algorithm</span><span class="p">,</span>
                <span class="n">last_temperature</span> <span class="o">=</span> <span class="n">last_temperature</span><span class="p">,</span>
                <span class="n">iteration</span> <span class="o">=</span> <span class="n">iteration</span><span class="p">,</span>
                <span class="n">gradients</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">gradients</span><span class="p">),</span>
                <span class="n">sim_mat_savepath</span> <span class="o">=</span> <span class="n">sim_matrices_savepath</span><span class="p">,</span>
                <span class="n">temperature_save_path</span> <span class="o">=</span> <span class="n">metrics_savepath</span><span class="p">,</span>
                <span class="n">clustering_shot</span> <span class="o">=</span> <span class="n">clustering_shot</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">[</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">loop_current_clusters_keys</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="c1"># Copy obj for iterating # Copy obj for iterating</span>
        <span class="c1"># Step V: In-cluster aggregation</span>
        <span class="k">for</span> <span class="n">cluster_signature</span> <span class="ow">in</span> <span class="n">loop_current_clusters_keys</span><span class="p">:</span>
            <span class="c1"># Collect in-cluster gradients</span>
            <span class="n">in_cluster_gradients</span> <span class="o">=</span> <span class="n">select_gradients</span><span class="p">(</span>
            <span class="n">nodes_id_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>
            <span class="n">gradients</span><span class="o">=</span><span class="n">gradients</span>
            <span class="p">)</span>
            <span class="n">avg_incluster_gradients</span> <span class="o">=</span> <span class="n">average_of_weigts</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">in_cluster_gradients</span><span class="p">))</span>
            <span class="c1"># Updating weights</span>
            <span class="n">new_incluster_weights</span> <span class="o">=</span> <span class="n">aggrgator</span><span class="o">.</span><span class="n">optimize_weights</span><span class="p">(</span>
                <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">gradients</span> <span class="o">=</span> <span class="n">avg_incluster_gradients</span><span class="p">,</span>
                <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Update weights of the cluster model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_incluster_weights</span><span class="p">)</span>
            <span class="c1"># Updating weights for each node in the cluster</span>
            <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">node_id</span> <span class="o">==</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">new_incluster_weights</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_signature</span>

        <span class="c1"># # Step VI: Mixing the global model</span>
        <span class="c1"># avg_global_gradients = average_of_weigts(gradients)</span>
        <span class="c1"># # Updating the weights for the central model</span>
        <span class="c1"># new_global_weights = aggrgator.optimize_weights(</span>
        <span class="c1">#         weights=self.orchestrator_model.get_weights(),</span>
        <span class="c1">#         gradients = avg_global_gradients,</span>
        <span class="c1">#         learning_rate = learning_rate,</span>
        <span class="c1">#         )</span>
        <span class="c1"># self.orchestrator_model.update_weights(new_global_weights)</span>

        <span class="c1"># # Step VII: Post-training evaluation</span>
        <span class="c1"># # Preserving the orchestrator&#39;s model</span>
        <span class="c1"># self.orchestrator_model.store_model_on_disk(iteration=iteration,</span>
        <span class="c1">#                                             path=orchestrator_models_savepath)</span>
        <span class="c1"># Evaluating the new set of weights on local datasets.</span>
        <span class="n">automatic_node_evaluation</span><span class="p">(</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;after_update_metrics.csv&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># # Evaluating the new set of weights on orchestrator&#39;s dataset.</span>
        <span class="c1"># evaluate_model(</span>
        <span class="c1">#     iteration=iteration,</span>
        <span class="c1">#     model=self.orchestrator_model,</span>
        <span class="c1">#     save_path=os.path.join(metrics_savepath, &quot;orchestrator_metrics.csv&quot;))</span>

    <span class="c1"># Step VIII: Out-of-loop (end of the training)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cluster_structure_savepath</span><span class="p">,</span> <span class="s2">&quot;all_clustering_structures&quot;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">save_nested_dict_ascsv</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s1">&#39;cluster_id_mapping.csv&#39;</span><span class="p">))</span>
    <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Training complete&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="simulation.simulation.Simulation.training_protocol_sattler" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">training_protocol_sattler</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">local_epochs</span><span class="p">,</span> <span class="n">aggrgator</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">,</span> <span class="n">EPS1</span><span class="p">,</span> <span class="n">EPS2</span><span class="p">,</span> <span class="n">round_cooldown</span><span class="p">,</span> <span class="n">metrics_savepath</span><span class="p">,</span> <span class="n">nodes_models_savepath</span><span class="p">,</span> <span class="n">orchestrator_models_savepath</span><span class="p">,</span> <span class="n">sim_matrices_savepath</span><span class="p">,</span> <span class="n">cluster_structure_savepath</span><span class="p">,</span> <span class="n">batch_job</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Performs a full federated training according to the initialized
settings. The train_protocol of the generic_orchestrator.Orchestrator
follows a classic FedOpt algorithm - it averages the local gradients 
and aggregates them using a selecred optimizer.
SOURCE: </p>
<h5 id="simulation.simulation.Simulation.training_protocol_sattler--parameters">Parameters</h5>
<p>iterations: int
    Number of (global) iterations // epochs to train the models for.
sample_size: int
    Size of the sample
local_epochs: int
    Number of local epochs for which the local model should
    be trained.
aggregator: Aggregator
    Instance of the Aggregator object that will be used to aggregate the result each round
learning_rate: float
    Learning rate to be used for optimization.
metrics_savepath: str
    Path for saving the metrics
nodes_models_savepath: str
    Path for saving the models in the .pt format.
orchestrator_models_savepath: str
    Path for saving the orchestrator models.
clustering_root_savepath: str
    Path for saving all the clustering results (general).
sim_matrices_savepath: str
    Path for saving all the similarity matrices.
cluster_structure_savepath: str
    Path for saving all the cluster structures.
Returns</p>
<hr />
<p>int
    Returns 0 on the successful completion of the training.</p>

            <details class="quote">
              <summary>Source code in <code>EFL\simulation\simulation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">training_protocol_sattler</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">iterations</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">local_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">aggrgator</span><span class="p">:</span> <span class="n">Aggregator</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">EPS1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">EPS2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">round_cooldown</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">metrics_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">nodes_models_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">orchestrator_models_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">sim_matrices_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">cluster_structure_savepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">batch_job</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Performs a full federated training according to the initialized</span>
<span class="sd">    settings. The train_protocol of the generic_orchestrator.Orchestrator</span>
<span class="sd">    follows a classic FedOpt algorithm - it averages the local gradients </span>
<span class="sd">    and aggregates them using a selecred optimizer.</span>
<span class="sd">    SOURCE: </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    iterations: int</span>
<span class="sd">        Number of (global) iterations // epochs to train the models for.</span>
<span class="sd">    sample_size: int</span>
<span class="sd">        Size of the sample</span>
<span class="sd">    local_epochs: int</span>
<span class="sd">        Number of local epochs for which the local model should</span>
<span class="sd">        be trained.</span>
<span class="sd">    aggregator: Aggregator</span>
<span class="sd">        Instance of the Aggregator object that will be used to aggregate the result each round</span>
<span class="sd">    learning_rate: float</span>
<span class="sd">        Learning rate to be used for optimization.</span>
<span class="sd">    metrics_savepath: str</span>
<span class="sd">        Path for saving the metrics</span>
<span class="sd">    nodes_models_savepath: str</span>
<span class="sd">        Path for saving the models in the .pt format.</span>
<span class="sd">    orchestrator_models_savepath: str</span>
<span class="sd">        Path for saving the orchestrator models.</span>
<span class="sd">    clustering_root_savepath: str</span>
<span class="sd">        Path for saving all the clustering results (general).</span>
<span class="sd">    sim_matrices_savepath: str</span>
<span class="sd">        Path for saving all the similarity matrices.</span>
<span class="sd">    cluster_structure_savepath: str</span>
<span class="sd">        Path for saving all the cluster structures.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Returns 0 on the successful completion of the training.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Step I: Create first cluster (the whole population)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">Cluster_Structure</span><span class="p">(</span>
        <span class="n">population</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">]),</span> <span class="c1"># First cluster, all nodes belonging to it.</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()),</span> <span class="c1"># Model for the first cluster, direct copy of the central orchestrator model.</span>
        <span class="n">iteration</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># Created During the First Iteration</span>
    <span class="p">)}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]}</span> <span class="c1"># List of all clusters that were created during the simulation</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span> <span class="c1"># mapping between iteration: {node: cluster_id}</span>

    <span class="c1"># Step II: Looping over the iterations</span>
    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
        <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>            
        <span class="c1"># Sampling nodes</span>
        <span class="n">sampled_nodes</span> <span class="o">=</span> <span class="n">sample_nodes</span><span class="p">(</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
            <span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span><span class="p">,</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span>
        <span class="p">)</span>

        <span class="c1"># Step III: Training nodes</span>
        <span class="n">training_results</span><span class="p">,</span> <span class="n">gradients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_epoch</span><span class="p">(</span>
            <span class="n">sampled_nodes</span><span class="o">=</span><span class="n">sampled_nodes</span><span class="p">,</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">local_epochs</span><span class="o">=</span><span class="n">local_epochs</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;gradients&#39;</span><span class="p">,</span>
            <span class="n">save_model</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">nodes_models_savepath</span><span class="p">,</span>
            <span class="n">batch_job</span><span class="o">=</span><span class="n">batch_job</span>
        <span class="p">)</span>
        <span class="c1"># Preserving metrics of the training</span>
        <span class="n">save_nested_dict_ascsv</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">training_results</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s1">&#39;training_metrics.csv&#39;</span><span class="p">))</span>
        <span class="c1"># Testing nodes on the local dataset before the model update (only sampled nodes).</span>
        <span class="n">automatic_node_evaluation</span><span class="p">(</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">nodes</span><span class="o">=</span><span class="n">sampled_nodes</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;before_update_metrics.csv&quot;</span><span class="p">))</span>
                    <span class="c1"># Evaluating the generalizability of the local model</span>
        <span class="n">automatic_generalizability_evaluation</span><span class="p">(</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
            <span class="n">general_model</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orchestrator_model</span><span class="p">),</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;after_update_generalizability.csv&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Clustering</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sattler_clustering</span><span class="p">(</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">gradients</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">gradients</span><span class="p">),</span>
            <span class="n">EPS_1</span><span class="o">=</span><span class="n">EPS1</span><span class="p">,</span>
            <span class="n">EPS_2</span><span class="o">=</span><span class="n">EPS2</span><span class="p">,</span>
            <span class="n">round_cooldown</span><span class="o">=</span><span class="n">round_cooldown</span><span class="p">,</span>
            <span class="n">sim_mat_savepath</span><span class="o">=</span><span class="n">sim_matrices_savepath</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">[</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">loop_current_clusters_keys</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="c1"># Copy obj for iterating # Copy obj for iterating</span>
        <span class="c1"># Step V: In-cluster aggregation</span>
        <span class="k">for</span> <span class="n">cluster_signature</span> <span class="ow">in</span> <span class="n">loop_current_clusters_keys</span><span class="p">:</span>
            <span class="c1"># Collect in-cluster gradients</span>
            <span class="n">in_cluster_gradients</span> <span class="o">=</span> <span class="n">select_gradients</span><span class="p">(</span>
            <span class="n">nodes_id_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>
            <span class="n">gradients</span><span class="o">=</span><span class="n">gradients</span>
            <span class="p">)</span>
            <span class="n">avg_incluster_gradients</span> <span class="o">=</span> <span class="n">average_of_weigts</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">in_cluster_gradients</span><span class="p">))</span>
            <span class="c1"># Updating weights</span>
            <span class="n">new_incluster_weights</span> <span class="o">=</span> <span class="n">aggrgator</span><span class="o">.</span><span class="n">optimize_weights</span><span class="p">(</span>
                <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">gradients</span> <span class="o">=</span> <span class="n">avg_incluster_gradients</span><span class="p">,</span>
                <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Update weights of the cluster model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_incluster_weights</span><span class="p">)</span>
            <span class="c1"># Updating weights for each node in the cluster</span>
            <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_clusters</span><span class="p">[</span><span class="n">cluster_signature</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">node_id</span> <span class="o">==</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">new_incluster_weights</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_signature</span>

        <span class="c1"># # Step VI: Mixing the global model</span>
        <span class="c1"># avg_global_gradients = average_of_weigts(gradients)</span>
        <span class="c1"># # Updating the weights for the central model</span>
        <span class="c1"># new_global_weights = aggrgator.optimize_weights(</span>
        <span class="c1">#         weights=self.orchestrator_model.get_weights(),</span>
        <span class="c1">#         gradients = avg_global_gradients,</span>
        <span class="c1">#         learning_rate = learning_rate,</span>
        <span class="c1">#         )</span>
        <span class="c1"># self.orchestrator_model.update_weights(new_global_weights)</span>

        <span class="c1"># # Step VII: Post-training evaluation</span>
        <span class="c1"># # Preserving the orchestrator&#39;s model</span>
        <span class="c1"># self.orchestrator_model.store_model_on_disk(iteration=iteration,</span>
        <span class="c1">#                                             path=orchestrator_models_savepath)</span>
        <span class="c1"># Evaluating the new set of weights on local datasets.</span>
        <span class="n">automatic_node_evaluation</span><span class="p">(</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s2">&quot;after_update_metrics.csv&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Evaluating the new set of weights on orchestrator&#39;s dataset.</span>
        <span class="c1"># evaluate_model(</span>
        <span class="c1">#     iteration=iteration,</span>
        <span class="c1">#     model=self.orchestrator_model,</span>
        <span class="c1">#     save_path=os.path.join(metrics_savepath, &quot;orchestrator_metrics.csv&quot;))</span>

    <span class="c1"># Step VIII: Out-of-loop (end of the training)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cluster_structure_savepath</span><span class="p">,</span> <span class="s2">&quot;all_clustering_structures&quot;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_clusters</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">save_nested_dict_ascsv</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_cluster_mapping</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> <span class="s1">&#39;cluster_id_mapping.csv&#39;</span><span class="p">))</span>
    <span class="n">orchestrator_logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Training complete&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="basic-operations">Basic Operations</h2>


<div class="doc doc-object doc-module">



<a id="operations.evaluations"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="operations.evaluations.automatic_node_evaluation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">automatic_node_evaluation</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_to_screen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Used to automatically evaluate a set of provided node and preserve metrics in the indicated 
directory.</p>
<h4 id="operations.evaluations.automatic_node_evaluation--parameters">Parameters</h4>
<p>iteration: int 
    Current iteration of the training.
nodes: dict[int: FederatedNode]
    Dictionary containing nodes to be evaluated.
saving_path: str (default to None)
    The saving path of the csv file, must end with the .csv extension.
logger: Logger (default to None)
    Logger object that we want to use to handle the logs.
log_to_screen: bool (default to False)
    Boolean flag whether we want to log the results to the screen.</p>
<h4 id="operations.evaluations.automatic_node_evaluation--returns">Returns</h4>
<pre><code>None
</code></pre>

            <details class="quote">
              <summary>Source code in <code>EFL\operations\evaluations.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">automatic_node_evaluation</span><span class="p">(</span>
    <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
    <span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">:</span> <span class="n">FederatedNode</span><span class="p">],</span>
    <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">log_to_screen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Used to automatically evaluate a set of provided node and preserve metrics in the indicated </span>
<span class="sd">    directory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    iteration: int </span>
<span class="sd">        Current iteration of the training.</span>
<span class="sd">    nodes: dict[int: FederatedNode]</span>
<span class="sd">        Dictionary containing nodes to be evaluated.</span>
<span class="sd">    saving_path: str (default to None)</span>
<span class="sd">        The saving path of the csv file, must end with the .csv extension.</span>
<span class="sd">    logger: Logger (default to None)</span>
<span class="sd">        Logger object that we want to use to handle the logs.</span>
<span class="sd">    log_to_screen: bool (default to False)</span>
<span class="sd">        Boolean flag whether we want to log the results to the screen.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        None&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">evaluate_model</span><span class="p">(</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
            <span class="n">log_to_screen</span><span class="o">=</span><span class="n">log_to_screen</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="operations.evaluations.evaluate_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate_model</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_to_screen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">node_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Used to save the model metrics.</p>
<h4 id="operations.evaluations.evaluate_model--parameters">Parameters</h4>
<p>iteration: int 
    Current iteration of the training.
model: FederatedModel
    FederatedModel to be evaluated
saving_path: str (default to None)
    The saving path of the csv file, must end with the .csv extension.
logger: Logger (default to None)
    Logger object that we want to use to handle the logs.
log_to_screen: bool (default to False)
    Boolean flag whether we want to log the results to the screen.</p>
<h4 id="operations.evaluations.evaluate_model--returns">Returns</h4>
<pre><code>None
</code></pre>

            <details class="quote">
              <summary>Source code in <code>EFL\operations\evaluations.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">evaluate_model</span><span class="p">(</span>
    <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
    <span class="n">model</span><span class="p">:</span> <span class="n">FederatedModel</span><span class="p">,</span>
    <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">log_to_screen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">node_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Used to save the model metrics.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    iteration: int </span>
<span class="sd">        Current iteration of the training.</span>
<span class="sd">    model: FederatedModel</span>
<span class="sd">        FederatedModel to be evaluated</span>
<span class="sd">    saving_path: str (default to None)</span>
<span class="sd">        The saving path of the csv file, must end with the .csv extension.</span>
<span class="sd">    logger: Logger (default to None)</span>
<span class="sd">        Logger object that we want to use to handle the logs.</span>
<span class="sd">    log_to_screen: bool (default to False)</span>
<span class="sd">        Boolean flag whether we want to log the results to the screen.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        None&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">evaluation_results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate_model</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">node_name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;node_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">node_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;node_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_name</span>
        <span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
        <span class="k">if</span> <span class="n">log_to_screen</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">pass</span>
            <span class="c1">#logger.info(f&quot;Evaluating model after iteration {iteration} on node {model.node_name}. Results: {metrics}&quot;)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to compute metrics. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;a+&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">saved_file</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">saved_file</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">evaluation_results</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="c1"># If the file does not exist, it will create it and write the header.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">evaluation_results</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="operations.orchestrations"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="operations.orchestrations.sample_nodes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sample_nodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">generator</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Sample the nodes given the provided sample size. If sample_size is bigger
or equal to the number of av. nodes, the sampler will return the original list.</p>
<h4 id="operations.orchestrations.sample_nodes--parameters">Parameters</h4>
<pre><code>nodes: dict[int: FederatedNode]) 
    Original dictionary of nodes to be sampled from.
sample_size: int,
    Size of the sample
generator: np.random.Generator
    A numpy generator initialized on the server side.
</code></pre>
<h4 id="operations.orchestrations.sample_nodes--returns">Returns</h4>
<pre><code>dict[id: FederatedNode]
</code></pre>

            <details class="quote">
              <summary>Source code in <code>EFL\operations\orchestrations.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sample_nodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">:</span> <span class="n">FederatedNode</span><span class="p">],</span> 
                 <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">id</span><span class="p">:</span> <span class="n">FederatedNode</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sample the nodes given the provided sample size. If sample_size is bigger</span>
<span class="sd">    or equal to the number of av. nodes, the sampler will return the original list.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        nodes: dict[int: FederatedNode]) </span>
<span class="sd">            Original dictionary of nodes to be sampled from.</span>
<span class="sd">        sample_size: int,</span>
<span class="sd">            Size of the sample</span>
<span class="sd">        generator: np.random.Generator</span>
<span class="sd">            A numpy generator initialized on the server side.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        dict[id: FederatedNode]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Conversion to array</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="o">.</span><span class="n">node_id</span><span class="p">:</span> <span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">}</span> <span class="c1"># Back-conversion to dicitonary</span>
    <span class="k">return</span> <span class="n">sample</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="operations.orchestrations.sample_weighted_nodes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sample_weighted_nodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="n">sampling_array</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Sample the nodes given the provided sample size. It requires passing a sampling array
containing list of weights associated with each node.</p>
<h4 id="operations.orchestrations.sample_weighted_nodes--parameters">Parameters</h4>
<pre><code>nodes: dict[int: FederatedNode]) 
    Original dictionary of nodes to be sampled from.
sample_size: int,
    Size of the sample
generator: np.random.Generator
    A numpy generator initialized on the server side.
sampling_array: np.array
    Sampling array containing weights for the sampling
</code></pre>
<h4 id="operations.orchestrations.sample_weighted_nodes--returns">Returns</h4>
<pre><code>dict[id: FederatedNode]
</code></pre>

            <details class="quote">
              <summary>Source code in <code>EFL\operations\orchestrations.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sample_weighted_nodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">:</span> <span class="n">FederatedNode</span><span class="p">],</span> 
                          <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                          <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span>
                          <span class="n">sampling_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">id</span><span class="p">:</span> <span class="n">FederatedNode</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sample the nodes given the provided sample size. It requires passing a sampling array</span>
<span class="sd">    containing list of weights associated with each node.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        nodes: dict[int: FederatedNode]) </span>
<span class="sd">            Original dictionary of nodes to be sampled from.</span>
<span class="sd">        sample_size: int,</span>
<span class="sd">            Size of the sample</span>
<span class="sd">        generator: np.random.Generator</span>
<span class="sd">            A numpy generator initialized on the server side.</span>
<span class="sd">        sampling_array: np.array</span>
<span class="sd">            Sampling array containing weights for the sampling</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        dict[id: FederatedNode]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">sampling_array</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="o">.</span><span class="n">node_id</span><span class="p">:</span> <span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">}</span> <span class="c1"># Back-conversion to dicitonary</span>
    <span class="k">return</span> <span class="n">sample</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="operations.orchestrations.train_nodes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train_nodes</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">local_epochs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;weights&#39;</span><span class="p">,</span> <span class="n">save_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Used to command the node to start the local training.
Invokes .train_local_model method and returns the results.</p>
<h4 id="operations.orchestrations.train_nodes--parameters">Parameters</h4>
<p>node: FederatedNode 
    Node that we want to train.
iteration: int
    Current (global) iteration.
local_epochs: int
    Number of local epochs for which to train a node
mode: str (default to False)
    Mode of the training. 
    Mode = 'weights': Node will return model's weights.
    Mode = 'gradients': Node will return model's gradients.
save_model: bool (default to False)
    Boolean flag to enable model saving.
save_path: str (default to None)
    Save path for preserving a model (applicable only when save_model = True)
Returns</p>
<hr />
<pre><code>tpule[int, OrderedDict, List[float], List[float]]
</code></pre>

            <details class="quote">
              <summary>Source code in <code>EFL\operations\orchestrations.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train_nodes</span><span class="p">(</span>
    <span class="n">node</span><span class="p">:</span> <span class="n">FederatedNode</span><span class="p">,</span>
    <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">local_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span>
    <span class="n">save_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Used to command the node to start the local training.</span>
<span class="sd">    Invokes .train_local_model method and returns the results.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    node: FederatedNode </span>
<span class="sd">        Node that we want to train.</span>
<span class="sd">    iteration: int</span>
<span class="sd">        Current (global) iteration.</span>
<span class="sd">    local_epochs: int</span>
<span class="sd">        Number of local epochs for which to train a node</span>
<span class="sd">    mode: str (default to False)</span>
<span class="sd">        Mode of the training. </span>
<span class="sd">        Mode = &#39;weights&#39;: Node will return model&#39;s weights.</span>
<span class="sd">        Mode = &#39;gradients&#39;: Node will return model&#39;s gradients.</span>
<span class="sd">    save_model: bool (default to False)</span>
<span class="sd">        Boolean flag to enable model saving.</span>
<span class="sd">    save_path: str (default to None)</span>
<span class="sd">        Save path for preserving a model (applicable only when save_model = True)</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        tpule[int, OrderedDict, List[float], List[float]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">node_id</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">,</span> <span class="n">accuracy_list</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">train_local_model</span><span class="p">(</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="n">iteration</span><span class="p">,</span>
        <span class="n">local_epochs</span> <span class="o">=</span> <span class="n">local_epochs</span><span class="p">,</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">,</span>
        <span class="n">save_model</span> <span class="o">=</span> <span class="n">save_model</span><span class="p">,</span>
        <span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">,</span> <span class="n">accuracy_list</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="aggregators.aggregator"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="aggregators.aggregator.Aggregator" class="doc doc-heading">
            <code>Aggregator</code>


</h2>


    <div class="doc doc-contents ">


        <p>Basic class for all Federated Aggregators</p>

              <details class="quote">
                <summary>Source code in <code>EFL\aggregators\aggregator.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Aggregator</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Basic class for all Federated Aggregators&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">aggregate_weights</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Basic aggregate function (equal to FedAvg) that returns the aggregate version of the</span>
<span class="sd">        weights. Perform deepcopy on the passed parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        weights: dict[int: OrderedDict]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        OrderedDict&quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="c1">#Here we could add copy and deepcopy</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="aggregators.aggregator.Aggregator.aggregate_weights" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Basic aggregate function (equal to FedAvg) that returns the aggregate version of the
weights. Perform deepcopy on the passed parameters.</p>
<h5 id="aggregators.aggregator.Aggregator.aggregate_weights--parameters">Parameters</h5>
<p>weights: dict[int: OrderedDict]</p>
<h5 id="aggregators.aggregator.Aggregator.aggregate_weights--returns">Returns</h5>
<p>OrderedDict</p>

            <details class="quote">
              <summary>Source code in <code>EFL\aggregators\aggregator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">aggregate_weights</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Basic aggregate function (equal to FedAvg) that returns the aggregate version of the</span>
<span class="sd">    weights. Perform deepcopy on the passed parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights: dict[int: OrderedDict]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    OrderedDict&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="c1">#Here we could add copy and deepcopy</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="basic-file-handling">Basic File Handling</h2>


<div class="doc doc-object doc-module">



<a id="files.archive"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="files.archive.create_archive" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_archive</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">archive_name</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> %m %Y %H %M %S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">()))</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Creates a basic directory structure for preserving simulation files.
Returns Paths to metrics save location, nodes (models) save location and
orchestrator (models) save location. The directory complies with the following
structure:
---root
    ---archive_name
        ---results
        ---models
            ---orchestrator models
            ---nodes models</p>
<p>Returns paths in order (metrics_savepath, nodes_models_savepath, 
orchestrator_model_savepath).</p>
<h4 id="files.archive.create_archive--parameters">Parameters</h4>
<p>path: str | Path
    Path-like object to the root directory in which the archive should be created
archive_name: str (default to time.strftime("%d.%m.%Y %H:%M%S", time.gmtime())
    Name of the archive.</p>
<h4 id="files.archive.create_archive--returns">Returns</h4>
<p>tuple[str, str str]</p>

            <details class="quote">
              <summary>Source code in <code>EFL\files\archive.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_archive</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">archive_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> %m %Y %H %M %S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a basic directory structure for preserving simulation files.</span>
<span class="sd">    Returns Paths to metrics save location, nodes (models) save location and</span>
<span class="sd">    orchestrator (models) save location. The directory complies with the following</span>
<span class="sd">    structure:</span>
<span class="sd">    ---root</span>
<span class="sd">        ---archive_name</span>
<span class="sd">            ---results</span>
<span class="sd">            ---models</span>
<span class="sd">                ---orchestrator models</span>
<span class="sd">                ---nodes models</span>

<span class="sd">    Returns paths in order (metrics_savepath, nodes_models_savepath, </span>
<span class="sd">    orchestrator_model_savepath).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path: str | Path</span>
<span class="sd">        Path-like object to the root directory in which the archive should be created</span>
<span class="sd">    archive_name: str (default to time.strftime(&quot;%d.%m.%Y %H:%M%S&quot;, time.gmtime())</span>
<span class="sd">        Name of the archive.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[str, str str]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">archive_name</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Directory </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2"> already exists&quot;</span> 

    <span class="n">metrics_savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;results&#39;</span><span class="p">)</span>
    <span class="n">orchestrator_model_savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;orchestrator&#39;</span><span class="p">)</span>
    <span class="n">nodes_models_savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;nodes&#39;</span><span class="p">)</span>
    <span class="n">clustering_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;clustering&#39;</span><span class="p">)</span>
    <span class="n">sim_matrices_savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">clustering_root</span><span class="p">,</span> <span class="s1">&#39;similarity_matrices&#39;</span><span class="p">)</span>
    <span class="n">cluster_structure_savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">clustering_root</span><span class="p">,</span> <span class="s1">&#39;clustering_structure&#39;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">nodes_models_savepath</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">orchestrator_model_savepath</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">clustering_root</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">sim_matrices_savepath</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cluster_structure_savepath</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">metrics_savepath</span><span class="p">,</span> 
           <span class="n">nodes_models_savepath</span><span class="p">,</span> 
           <span class="n">orchestrator_model_savepath</span><span class="p">,</span>
           <span class="n">clustering_root</span><span class="p">,</span>
           <span class="n">sim_matrices_savepath</span><span class="p">,</span>
           <span class="n">cluster_structure_savepath</span><span class="p">)</span> 
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="files.handlers"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="files.handlers.save_dict_ascsv" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_dict_ascsv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Attaches models of the nodes to the simulation instance.</p>
<h4 id="files.handlers.save_dict_ascsv--parameters">Parameters</h4>
<p>data: dict
    Dictionary containing the data. Data in the dictionary will be transformed
    and saved under fieldnames formed by keys.
save_path: str
    A full save path for preserving the dictionary. Must end with *.csv file extension.
Returns</p>
<hr />
<p>None</p>

            <details class="quote">
              <summary>Source code in <code>EFL\files\handlers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save_dict_ascsv</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Attaches models of the nodes to the simulation instance.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: dict</span>
<span class="sd">        Dictionary containing the data. Data in the dictionary will be transformed</span>
<span class="sd">        and saved under fieldnames formed by keys.</span>
<span class="sd">    save_path: str</span>
<span class="sd">        A full save path for preserving the dictionary. Must end with *.csv file extension.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c1"># Checks if the file already exists, otherwise writer header</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="files.handlers.save_nested_dict_ascsv" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_nested_dict_ascsv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Attaches models of the nodes to the simulation instance.</p>
<h4 id="files.handlers.save_nested_dict_ascsv--parameters">Parameters</h4>
<p>data: dict[dict]
    Nested dict containing the data. Note that the external key will not be saved, only the 
    data in the internal dictionary will be transformed to fieldnames and saved.
save_path: str
    A full save path for preserving the dictionary. Must end with *.csv file extension.
Returns</p>
<hr />
<p>None</p>

            <details class="quote">
              <summary>Source code in <code>EFL\files\handlers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save_nested_dict_ascsv</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
    <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Attaches models of the nodes to the simulation instance.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: dict[dict]</span>
<span class="sd">        Nested dict containing the data. Note that the external key will not be saved, only the </span>
<span class="sd">        data in the internal dictionary will be transformed to fieldnames and saved.</span>
<span class="sd">    save_path: str</span>
<span class="sd">        A full save path for preserving the dictionary. Must end with *.csv file extension.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c1"># Checks if the file already exists, otherwise writer header</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="files.loggers"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">











  </div>

    </div>

</div><h2 id="basic-aggregators">Basic Aggregators</h2>


<div class="doc doc-object doc-module">



<a id="aggregators.aggregator"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="aggregators.aggregator.Aggregator" class="doc doc-heading">
            <code>Aggregator</code>


</h2>


    <div class="doc doc-contents ">


        <p>Basic class for all Federated Aggregators</p>

              <details class="quote">
                <summary>Source code in <code>EFL\aggregators\aggregator.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Aggregator</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Basic class for all Federated Aggregators&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">aggregate_weights</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Basic aggregate function (equal to FedAvg) that returns the aggregate version of the</span>
<span class="sd">        weights. Perform deepcopy on the passed parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        weights: dict[int: OrderedDict]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        OrderedDict&quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="c1">#Here we could add copy and deepcopy</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="aggregators.aggregator.Aggregator.aggregate_weights" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Basic aggregate function (equal to FedAvg) that returns the aggregate version of the
weights. Perform deepcopy on the passed parameters.</p>
<h5 id="aggregators.aggregator.Aggregator.aggregate_weights--parameters">Parameters</h5>
<p>weights: dict[int: OrderedDict]</p>
<h5 id="aggregators.aggregator.Aggregator.aggregate_weights--returns">Returns</h5>
<p>OrderedDict</p>

            <details class="quote">
              <summary>Source code in <code>EFL\aggregators\aggregator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">aggregate_weights</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Basic aggregate function (equal to FedAvg) that returns the aggregate version of the</span>
<span class="sd">    weights. Perform deepcopy on the passed parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights: dict[int: OrderedDict]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    OrderedDict&quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="c1">#Here we could add copy and deepcopy</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="aggregators.distances"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="aggregators.fedopt_aggregator"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="aggregators.fedopt_aggregator.Fedopt_Optimizer" class="doc doc-heading">
            <code>Fedopt_Optimizer</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="EFL.aggregators.aggregator.Aggregator">Aggregator</span></code></p>


        <p>Fedopt Optimizer that performs a generalized 
version of Federated Averaging. Suitable for performing
Federated Optimization based on gradients, with 
verying learning rates.</p>
<h4 id="aggregators.fedopt_aggregator.Fedopt_Optimizer--attributes">Attributes</h4>
<p>None</p>

              <details class="quote">
                <summary>Source code in <code>EFL\aggregators\fedopt_aggregator.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Fedopt_Optimizer</span><span class="p">(</span><span class="n">Aggregator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fedopt Optimizer that performs a generalized </span>
<span class="sd">    version of Federated Averaging. Suitable for performing</span>
<span class="sd">    Federated Optimization based on gradients, with </span>
<span class="sd">    verying learning rates.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">optimize_weights</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">:</span><span class="n">OrderedDict</span><span class="p">],</span>
        <span class="n">gradients</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">],</span>
        <span class="n">learning_rate</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;FedOpt Aggregation Function (equal to FedAvg when lr=1.0) that returns the </span>
<span class="sd">        updated version of the weights.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        weights: dict[int: OrderedDict]</span>
<span class="sd">            Weights of the previous (central) model.</span>
<span class="sd">        gradients: dict[int: OrderedDict]</span>
<span class="sd">            Gradients (defined as trainedmodel - dispatched model)</span>
<span class="sd">        learning_rate: float</span>
<span class="sd">            Learning rate used to </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        OrderedDict&quot;&quot;&quot;</span>        
        <span class="n">updated_weights</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">zeros</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">()))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">:</span>
            <span class="n">updated_weights</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">gradients</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">updated_weights</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="aggregators.fedopt_aggregator.Fedopt_Optimizer.optimize_weights" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">gradients</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>FedOpt Aggregation Function (equal to FedAvg when lr=1.0) that returns the 
updated version of the weights.</p>
<h5 id="aggregators.fedopt_aggregator.Fedopt_Optimizer.optimize_weights--parameters">Parameters</h5>
<p>weights: dict[int: OrderedDict]
    Weights of the previous (central) model.
gradients: dict[int: OrderedDict]
    Gradients (defined as trainedmodel - dispatched model)
learning_rate: float
    Learning rate used to </p>
<h5 id="aggregators.fedopt_aggregator.Fedopt_Optimizer.optimize_weights--returns">Returns</h5>
<p>OrderedDict</p>

            <details class="quote">
              <summary>Source code in <code>EFL\aggregators\fedopt_aggregator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">optimize_weights</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">:</span><span class="n">OrderedDict</span><span class="p">],</span>
    <span class="n">gradients</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">],</span>
    <span class="n">learning_rate</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderedDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FedOpt Aggregation Function (equal to FedAvg when lr=1.0) that returns the </span>
<span class="sd">    updated version of the weights.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights: dict[int: OrderedDict]</span>
<span class="sd">        Weights of the previous (central) model.</span>
<span class="sd">    gradients: dict[int: OrderedDict]</span>
<span class="sd">        Gradients (defined as trainedmodel - dispatched model)</span>
<span class="sd">    learning_rate: float</span>
<span class="sd">        Learning rate used to </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    OrderedDict&quot;&quot;&quot;</span>        
    <span class="n">updated_weights</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">zeros</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">()))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">:</span>
        <span class="n">updated_weights</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">gradients</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">updated_weights</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="aggregators.temperature"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">











  </div>

    </div>

</div><h2 id="basic-operations_1">Basic Operations</h2>


<div class="doc doc-object doc-module">



<a id="operations.evaluations"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="operations.evaluations.automatic_node_evaluation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">automatic_node_evaluation</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_to_screen</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Used to automatically evaluate a set of provided node and preserve metrics in the indicated 
directory.</p>
<h4 id="operations.evaluations.automatic_node_evaluation--parameters">Parameters</h4>
<p>iteration: int 
    Current iteration of the training.
nodes: dict[int: FederatedNode]
    Dictionary containing nodes to be evaluated.
saving_path: str (default to None)
    The saving path of the csv file, must end with the .csv extension.
logger: Logger (default to None)
    Logger object that we want to use to handle the logs.
log_to_screen: bool (default to False)
    Boolean flag whether we want to log the results to the screen.</p>
<h4 id="operations.evaluations.automatic_node_evaluation--returns">Returns</h4>
<pre><code>None
</code></pre>

            <details class="quote">
              <summary>Source code in <code>EFL\operations\evaluations.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">automatic_node_evaluation</span><span class="p">(</span>
    <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
    <span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">:</span> <span class="n">FederatedNode</span><span class="p">],</span>
    <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">log_to_screen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Used to automatically evaluate a set of provided node and preserve metrics in the indicated </span>
<span class="sd">    directory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    iteration: int </span>
<span class="sd">        Current iteration of the training.</span>
<span class="sd">    nodes: dict[int: FederatedNode]</span>
<span class="sd">        Dictionary containing nodes to be evaluated.</span>
<span class="sd">    saving_path: str (default to None)</span>
<span class="sd">        The saving path of the csv file, must end with the .csv extension.</span>
<span class="sd">    logger: Logger (default to None)</span>
<span class="sd">        Logger object that we want to use to handle the logs.</span>
<span class="sd">    log_to_screen: bool (default to False)</span>
<span class="sd">        Boolean flag whether we want to log the results to the screen.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        None&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">evaluate_model</span><span class="p">(</span>
            <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
            <span class="n">log_to_screen</span><span class="o">=</span><span class="n">log_to_screen</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="operations.evaluations.evaluate_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate_model</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_to_screen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">node_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Used to save the model metrics.</p>
<h4 id="operations.evaluations.evaluate_model--parameters">Parameters</h4>
<p>iteration: int 
    Current iteration of the training.
model: FederatedModel
    FederatedModel to be evaluated
saving_path: str (default to None)
    The saving path of the csv file, must end with the .csv extension.
logger: Logger (default to None)
    Logger object that we want to use to handle the logs.
log_to_screen: bool (default to False)
    Boolean flag whether we want to log the results to the screen.</p>
<h4 id="operations.evaluations.evaluate_model--returns">Returns</h4>
<pre><code>None
</code></pre>

            <details class="quote">
              <summary>Source code in <code>EFL\operations\evaluations.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">evaluate_model</span><span class="p">(</span>
    <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
    <span class="n">model</span><span class="p">:</span> <span class="n">FederatedModel</span><span class="p">,</span>
    <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">log_to_screen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">node_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Used to save the model metrics.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    iteration: int </span>
<span class="sd">        Current iteration of the training.</span>
<span class="sd">    model: FederatedModel</span>
<span class="sd">        FederatedModel to be evaluated</span>
<span class="sd">    saving_path: str (default to None)</span>
<span class="sd">        The saving path of the csv file, must end with the .csv extension.</span>
<span class="sd">    logger: Logger (default to None)</span>
<span class="sd">        Logger object that we want to use to handle the logs.</span>
<span class="sd">    log_to_screen: bool (default to False)</span>
<span class="sd">        Boolean flag whether we want to log the results to the screen.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        None&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">evaluation_results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate_model</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">node_name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;node_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">node_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;node_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_name</span>
        <span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
        <span class="k">if</span> <span class="n">log_to_screen</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">pass</span>
            <span class="c1">#logger.info(f&quot;Evaluating model after iteration {iteration} on node {model.node_name}. Results: {metrics}&quot;)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to compute metrics. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;a+&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">saved_file</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">saved_file</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">evaluation_results</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="c1"># If the file does not exist, it will create it and write the header.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">evaluation_results</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="operations.orchestrations"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="operations.orchestrations.sample_nodes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sample_nodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">generator</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Sample the nodes given the provided sample size. If sample_size is bigger
or equal to the number of av. nodes, the sampler will return the original list.</p>
<h4 id="operations.orchestrations.sample_nodes--parameters">Parameters</h4>
<pre><code>nodes: dict[int: FederatedNode]) 
    Original dictionary of nodes to be sampled from.
sample_size: int,
    Size of the sample
generator: np.random.Generator
    A numpy generator initialized on the server side.
</code></pre>
<h4 id="operations.orchestrations.sample_nodes--returns">Returns</h4>
<pre><code>dict[id: FederatedNode]
</code></pre>

            <details class="quote">
              <summary>Source code in <code>EFL\operations\orchestrations.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sample_nodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">:</span> <span class="n">FederatedNode</span><span class="p">],</span> 
                 <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">id</span><span class="p">:</span> <span class="n">FederatedNode</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sample the nodes given the provided sample size. If sample_size is bigger</span>
<span class="sd">    or equal to the number of av. nodes, the sampler will return the original list.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        nodes: dict[int: FederatedNode]) </span>
<span class="sd">            Original dictionary of nodes to be sampled from.</span>
<span class="sd">        sample_size: int,</span>
<span class="sd">            Size of the sample</span>
<span class="sd">        generator: np.random.Generator</span>
<span class="sd">            A numpy generator initialized on the server side.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        dict[id: FederatedNode]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Conversion to array</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="o">.</span><span class="n">node_id</span><span class="p">:</span> <span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">}</span> <span class="c1"># Back-conversion to dicitonary</span>
    <span class="k">return</span> <span class="n">sample</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="operations.orchestrations.sample_weighted_nodes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sample_weighted_nodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="n">sampling_array</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Sample the nodes given the provided sample size. It requires passing a sampling array
containing list of weights associated with each node.</p>
<h4 id="operations.orchestrations.sample_weighted_nodes--parameters">Parameters</h4>
<pre><code>nodes: dict[int: FederatedNode]) 
    Original dictionary of nodes to be sampled from.
sample_size: int,
    Size of the sample
generator: np.random.Generator
    A numpy generator initialized on the server side.
sampling_array: np.array
    Sampling array containing weights for the sampling
</code></pre>
<h4 id="operations.orchestrations.sample_weighted_nodes--returns">Returns</h4>
<pre><code>dict[id: FederatedNode]
</code></pre>

            <details class="quote">
              <summary>Source code in <code>EFL\operations\orchestrations.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sample_weighted_nodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">:</span> <span class="n">FederatedNode</span><span class="p">],</span> 
                          <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                          <span class="n">generator</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span>
                          <span class="n">sampling_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">id</span><span class="p">:</span> <span class="n">FederatedNode</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sample the nodes given the provided sample size. It requires passing a sampling array</span>
<span class="sd">    containing list of weights associated with each node.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        nodes: dict[int: FederatedNode]) </span>
<span class="sd">            Original dictionary of nodes to be sampled from.</span>
<span class="sd">        sample_size: int,</span>
<span class="sd">            Size of the sample</span>
<span class="sd">        generator: np.random.Generator</span>
<span class="sd">            A numpy generator initialized on the server side.</span>
<span class="sd">        sampling_array: np.array</span>
<span class="sd">            Sampling array containing weights for the sampling</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        dict[id: FederatedNode]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">sampling_array</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="o">.</span><span class="n">node_id</span><span class="p">:</span> <span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">}</span> <span class="c1"># Back-conversion to dicitonary</span>
    <span class="k">return</span> <span class="n">sample</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="operations.orchestrations.train_nodes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train_nodes</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">local_epochs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;weights&#39;</span><span class="p">,</span> <span class="n">save_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Used to command the node to start the local training.
Invokes .train_local_model method and returns the results.</p>
<h4 id="operations.orchestrations.train_nodes--parameters">Parameters</h4>
<p>node: FederatedNode 
    Node that we want to train.
iteration: int
    Current (global) iteration.
local_epochs: int
    Number of local epochs for which to train a node
mode: str (default to False)
    Mode of the training. 
    Mode = 'weights': Node will return model's weights.
    Mode = 'gradients': Node will return model's gradients.
save_model: bool (default to False)
    Boolean flag to enable model saving.
save_path: str (default to None)
    Save path for preserving a model (applicable only when save_model = True)
Returns</p>
<hr />
<pre><code>tpule[int, OrderedDict, List[float], List[float]]
</code></pre>

            <details class="quote">
              <summary>Source code in <code>EFL\operations\orchestrations.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train_nodes</span><span class="p">(</span>
    <span class="n">node</span><span class="p">:</span> <span class="n">FederatedNode</span><span class="p">,</span>
    <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">local_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span><span class="p">,</span>
    <span class="n">save_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Used to command the node to start the local training.</span>
<span class="sd">    Invokes .train_local_model method and returns the results.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    node: FederatedNode </span>
<span class="sd">        Node that we want to train.</span>
<span class="sd">    iteration: int</span>
<span class="sd">        Current (global) iteration.</span>
<span class="sd">    local_epochs: int</span>
<span class="sd">        Number of local epochs for which to train a node</span>
<span class="sd">    mode: str (default to False)</span>
<span class="sd">        Mode of the training. </span>
<span class="sd">        Mode = &#39;weights&#39;: Node will return model&#39;s weights.</span>
<span class="sd">        Mode = &#39;gradients&#39;: Node will return model&#39;s gradients.</span>
<span class="sd">    save_model: bool (default to False)</span>
<span class="sd">        Boolean flag to enable model saving.</span>
<span class="sd">    save_path: str (default to None)</span>
<span class="sd">        Save path for preserving a model (applicable only when save_model = True)</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        tpule[int, OrderedDict, List[float], List[float]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">node_id</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">,</span> <span class="n">accuracy_list</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">train_local_model</span><span class="p">(</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="n">iteration</span><span class="p">,</span>
        <span class="n">local_epochs</span> <span class="o">=</span> <span class="n">local_epochs</span><span class="p">,</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">,</span>
        <span class="n">save_model</span> <span class="o">=</span> <span class="n">save_model</span><span class="p">,</span>
        <span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">loss_list</span><span class="p">,</span> <span class="n">accuracy_list</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.56dfad97.min.js"></script>
      
    
  </body>
</html>